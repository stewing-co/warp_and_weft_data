<!DOCTYPE html>
<html lang="en" dir="ltr"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=4321&amp;path=livereload" data-no-instant defer></script>
  
                           
     


<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.136.2">
<title> | Warp and Weft Data</title>


<meta property="twitter:site" content="@blue_pibble">
<meta property="twitter:creator" content="@blue_pibble">







  
    
  
<meta name="description" content="Business Intelligence With R and Python">


<meta property="og:site_name" content="Warp and Weft Data">
<meta property="og:title" content=" | Warp and Weft Data">
<meta property="og:description" content="Business Intelligence With R and Python" />
<meta property="og:type" content="page" />
<meta property="og:url" content="http://localhost:4321/blog/bsky_unfollow_negative_people/post404c3df873eb.tmp/" />
<meta property="og:locale" content="en">




    
        <meta property="og:image" content="http://localhost:4321/blog/sidebar-listing.jpg" >
        <meta property="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="http://localhost:4321/blog/sidebar-listing.jpg" >
    
    
  
  <meta itemprop="name" content="Warp and Weft Data">
  <meta itemprop="description" content="I followed a ton of people using the new starter packs. Now I’m going to keep all my mutuals and unfollow the people I’m following who aren’t following me back and who have a net negative sentiment score on their posts.
# Load necessary librarieslibrary(DBI)library(duckdb)library(tidyverse)library(httr2)library(tidytext)library(parsedate) get_follow_relationships &lt;- function(db_path) {library(tidyverse)library(httr2)library(DBI)library(duckdb)# Create a logged-in API session objectsession &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.server.createSession&#34;) |&gt;req_method(&#34;POST&#34;) |&gt;req_body_json(list(identifier = Sys.getenv(&#34;BLUESKY_APP_USER&#34;),password = Sys.getenv(&#34;BLUESKY_APP_PASS&#34;))) |&gt;req_perform() |&gt;resp_body_json()# Get your own DID (Decentralized Identifier)self_handle &lt;- session$handleself_did &lt;- session$did# Function to get all follows or followersget_all_follows &lt;- function(endpoint_url, user_did) {all_users &lt;- list()cursor &lt;- NULLrepeat {req &lt;- request(endpoint_url) |&gt;req_method(&#34;GET&#34;) |&gt;req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) |&gt;req_url_query(actor = user_did)if (!is.null(cursor)) {req &lt;- req |&gt; req_url_query(cursor = cursor)}resp &lt;- req |&gt;req_error(is_error = function(resp)FALSE) |&gt;req_perform()if (resp_status(resp) &gt;= 400) {message(&#34;An error occurred fetching data: &#34;,resp_status_desc(resp))print(resp_body_string(resp))break}data &lt;- resp_body_json(resp)# Determine if fetching followers or followingif (&#34;followers&#34; %in% names(data)) {users &lt;- data$followers} else if (&#34;follows&#34; %in% names(data)) {users &lt;- data$follows} else {message(&#34;Unexpected data format.&#34;)break}# Check if users list is emptyif (length(users) == 0) {break}all_users &lt;- c(all_users, users)if (!is.null(data$cursor)) {cursor &lt;- data$cursor} else {break}Sys.sleep(0.1) # Pause to respect rate limits}# Process the users into a tibbleusers_df &lt;- map_dfr(all_users, function(user) {tibble(did = user$did,handle = user$handle,displayName = user$displayName %||% NA_character_,description = user$description %||% NA_character_,createdAt = user$createdAt %||% NA_character_)})return(users_df)}# Get followersmessage(&#34;Fetching your followers...&#34;)followers_df &lt;- get_all_follows(&#34;https://bsky.social/xrpc/app.bsky.graph.getFollowers&#34;,self_did)# Get followingmessage(&#34;Fetching users you are following...&#34;)following_df &lt;- get_all_follows(&#34;https://bsky.social/xrpc/app.bsky.graph.getFollows&#34;,self_did)# Identify relationshipsfollowers_handles &lt;- followers_df$handlefollowing_handles &lt;- following_df$handle# Users you are following who aren&#39;t following you backwwd_following &lt;- following_df %&gt;%filter(!handle %in% followers_handles) %&gt;%mutate(tag = &#34;wwd-following&#34;)# Users who are following you but you aren&#39;t following backwwd_follower &lt;- followers_df %&gt;%filter(!handle %in% following_handles) %&gt;%mutate(tag = &#34;wwd-follower&#34;)# Mutual followswwd_mutuals &lt;- following_df %&gt;%filter(handle %in% followers_handles) %&gt;%mutate(tag = &#34;wwd-mutuals&#34;)# Combine allrelationships_df &lt;- bind_rows(wwd_following, wwd_follower, wwd_mutuals)# Connect to the databasecon &lt;- dbConnect(duckdb::duckdb(), db_path)# Save relationships to the databasedbWriteTable(con, &#34;follow_relationships&#34;, relationships_df, overwrite = TRUE)# Disconnect from the databasedbDisconnect(con, shutdown = TRUE)message(&#34;Follow relationships have been stored in the database.&#34;)# Return the data framereturn(relationships_df)}# Define the path to your databasedb_path &lt;- &#34;C:/Users/steph/OneDrive/warp_and_weft_data/content/blog/bsky_sentiment_index/bluesky_data.duckdb&#34;# Call the function with the database pathrelationships &lt;- get_follow_relationships(db_path)# View the resultsprint(relationships)# Function to get posts from a vector of handles, fetching only new posts and writing to db as it fetchesget_posts_from_handles &lt;- function(handles, session, db_path) {# Load parsedate librarylibrary(parsedate)# Connect to the databasecon &lt;- dbConnect(duckdb::duckdb(), db_path)# Loop over each handlefor (handle in handles) {message(&#34;Fetching posts for handle: &#34;, handle)# Get the latest record_createdAt for this handle from the posts tablelatest_time_query &lt;- sprintf(&#34;SELECT MAX(record_createdAt) as latest_time FROM posts WHERE author_handle = &#39;%s&#39;&#34;,handle)latest_time_result &lt;- dbGetQuery(con, latest_time_query)latest_time &lt;- latest_time_result$latest_time[1]# If there is no latest_time (i.e., no posts for this handle), set to NULLif (is.na(latest_time) || is.null(latest_time)) {latest_time &lt;- NULLmessage(&#34;No existing posts found for handle: &#34;, handle)} else {message(&#34;Latest post time for &#34;, handle, &#34;: &#34;, latest_time)}# Initialize variables for fetching posts# We will process and write posts as we fetch themcursor &lt;- NULLkeep_fetching &lt;- TRUErepeat {# Construct the GET requestreq &lt;- request(&#34;https://bsky.social/xrpc/app.bsky.feed.getAuthorFeed&#34;) |&gt;req_method(&#34;GET&#34;) |&gt;req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) |&gt;req_url_query(actor = handle)# If cursor is not NULL, add it to the queryif (!is.null(cursor)) {req &lt;- req |&gt; req_url_query(cursor = cursor)}# Perform the requestresp &lt;- req |&gt;req_error(is_error = function(resp)FALSE) |&gt;req_perform()# Check if the response is an errorif (resp_status(resp) &gt;= 400) {message(&#34;An error occurred fetching posts for &#34;,handle,&#34;: &#34;,resp_status_desc(resp))# Optionally, print the response body for more detailsprint(resp_body_string(resp))break}# Parse the responsefeed_data &lt;- resp_body_json(resp)# Check if feed is emptyif (length(feed_data$feed) == 0) {message(&#34;No posts found for handle: &#34;, handle)break}# Process posts and check timestampsposts_to_add &lt;- list()for (post in feed_data$feed) {post_time &lt;- post$post$record$createdAt %||% &#34;&#34;if (post_time == &#34;&#34;)next # Skip if no timestamp# Parse the timestamps using parsedate::parse_iso_8601post_time_parsed &lt;- parse_iso_8601(post_time)latest_time_parsed &lt;- if (!is.null(latest_time))parse_iso_8601(latest_time)elseNULL# Compare post_time with latest_timeif (!is.null(latest_time_parsed) &amp;&amp;!is.na(post_time_parsed) &amp;&amp;post_time_parsed &lt;= latest_time_parsed) {# Reached posts we&#39;ve already fetchedkeep_fetching &lt;- FALSEbreak} else {# New post, add to the listposts_to_add &lt;- c(posts_to_add, list(post))}}# If there are new posts to add, process and write them to the databaseif (length(posts_to_add) &gt; 0) {posts_df &lt;- map_dfr(posts_to_add, function(post) {tibble(uri = post$post$uri,cid = post$post$cid,author_did = post$post$author$did %||% NA_character_,author_handle = post$post$author$handle %||% NA_character_,author_displayName = post$post$author$displayName %||% NA_character_,record_type = post$post$record$`$type` %||% NA_character_,record_text = post$post$record$text %||% NA_character_,record_createdAt = post$post$record$createdAt %||% NA_character_,reply_root = post$post$record$reply$root$uri %||% NA_character_,reply_parent = post$post$record$reply$parent$uri %||% NA_character_,repost_count = post$post$repostCount %||% NA_integer_,reply_count = post$post$replyCount %||% NA_integer_,like_count = post$post$likeCount %||% NA_integer_,indexed_at = post$post$indexedAt %||% NA_character_)})# Write the new posts to the &#39;posts&#39; table, appendingdbWriteTable(con, &#34;posts&#34;, posts_df, append = TRUE)message(&#34;Wrote &#34;, nrow(posts_df), &#34; new posts for handle: &#34;, handle)} else {message(&#34;No new posts to add for handle: &#34;, handle)}# Break the loop if we&#39;ve reached existing postsif (!keep_fetching) {break}# Update cursorif (!is.null(feed_data$cursor)) {cursor &lt;- feed_data$cursor} else {# No more pages to fetchbreak}# Optional: Pause to respect rate limitsSys.sleep(0.1)}}# Disconnect from the databasedbDisconnect(con, shutdown = FALSE) # Keep the database running for other operations}# Function to compute sentiment scores for new postscompute_sentiment_scores_for_new_posts &lt;- function(db_path) {library(DBI)library(duckdb)library(tidyverse)library(tidytext)# Connect to the databasecon &lt;- dbConnect(duckdb::duckdb(), db_path)# Get the list of uris of posts that already have sentiment scoresexisting_scores &lt;- dbGetQuery(con, &#34;SELECT uri FROM post_sentiment_scores&#34;)# Get the list of uris of all postsall_posts &lt;- dbGetQuery(con, &#34;SELECT uri, record_text FROM posts&#34;)# Filter posts that don&#39;t have sentiment scores yetposts_to_score &lt;- all_posts %&gt;%filter(!uri %in% existing_scores$uri) %&gt;%filter(!is.na(record_text))# If there are no new posts to score, exit the functionif (nrow(posts_to_score) == 0) {message(&#34;No new posts to compute sentiment scores for.&#34;)dbDisconnect(con, shutdown = FALSE)return(NULL)}# Tokenize the textposts_tokens &lt;- posts_to_score %&gt;%unnest_tokens(word, record_text)# Get the AFINN sentiment lexiconafinn &lt;- get_sentiments(&#34;afinn&#34;)# Join tokens with sentiment lexiconposts_sentiment &lt;- posts_tokens %&gt;%inner_join(afinn, by = &#34;word&#34;)# Compute sentiment score per postpost_sentiment_scores &lt;- posts_sentiment %&gt;%group_by(uri) %&gt;%summarise(sentiment_score = sum(value), .groups = &#34;drop&#34;)# Handle posts without sentiment wordsall_uris &lt;- posts_to_score$uripost_sentiment_scores &lt;- tibble(uri = all_uris) %&gt;%left_join(post_sentiment_scores, by = &#34;uri&#34;) %&gt;%mutate(sentiment_score = replace_na(sentiment_score, 0))# Write the new sentiment scores to the database, appendingdbWriteTable(con,&#34;post_sentiment_scores&#34;,post_sentiment_scores,append = TRUE)# Disconnect from the databasedbDisconnect(con, shutdown = FALSE)message(&#34;Sentiment scores computed for new posts.&#34;)}# Main script to get posts and compute average sentiment scoresmain &lt;- function() {# Create a logged-in API session object oncesession &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.server.createSession&#34;) |&gt;req_method(&#34;POST&#34;) |&gt;req_body_json(list(identifier = Sys.getenv(&#34;BLUESKY_APP_USER&#34;),password = Sys.getenv(&#34;BLUESKY_APP_PASS&#34;))) |&gt;req_perform() |&gt;resp_body_json()# Connect to the databasecon &lt;- dbConnect(duckdb::duckdb(), db_path)# Get the list of &#39;wwd-following&#39; handleswwd_following_df &lt;- dbGetQuery(con,&#34;SELECT * FROM follow_relationships WHERE tag = &#39;wwd-following&#39;&#34;)wwd_following_handles &lt;- unique(wwd_following_df$handle)# Disconnect from the databasedbDisconnect(con, shutdown = FALSE)# Fetch posts for the &#39;wwd-following&#39; handles, only new posts, writing to db as we fetchget_posts_from_handles(wwd_following_handles, session, db_path)# Compute sentiment scores for new postscompute_sentiment_scores_for_new_posts(db_path)# Connect to the databasecon &lt;- dbConnect(duckdb::duckdb(), db_path)# Build the list of handles for the SQL queryhandle_list &lt;- paste(sprintf(&#34;&#39;%s&#39;&#34;, wwd_following_handles), collapse = &#34;,&#34;)# Build the SQL query using sprintfsql_query &lt;- sprintf(&#34;SELECT p.*, s.sentiment_scoreFROM posts pLEFT JOIN post_sentiment_scores s ON p.uri = s.uriWHERE p.author_handle IN (%s)&#34;,handle_list)# Run the queryposts_with_sentiment &lt;- dbGetQuery(con, sql_query)# Disconnect from the databasedbDisconnect(con, shutdown = FALSE)# Compute average sentiment score per personaverage_sentiment_per_person &lt;- posts_with_sentiment %&gt;%group_by(author_handle) %&gt;%summarise(average_sentiment = mean(sentiment_score, na.rm = TRUE),.groups = &#34;drop&#34;)# View the resultsprint(average_sentiment_per_person)# Optionally, save the results to the databasecon &lt;- dbConnect(duckdb::duckdb(), db_path)dbWriteTable(con,&#34;wwd_following_average_sentiment&#34;,average_sentiment_per_person,overwrite = TRUE)dbDisconnect(con, shutdown = TRUE)message(&#34;Average sentiment scores computed and stored.&#34;)}# Run the main functionmain()# Define the database pathdb_path &lt;- &#34;C:/Users/steph/OneDrive/warp_and_weft_data/content/blog/bsky_sentiment_index/bluesky_data.duckdb&#34;# Function to unfollow users based on criteria, excluding those who are following youunfollow_users_based_on_criteria &lt;- function(db_path) {# Create a logged-in API session objectsession &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.server.createSession&#34;) %&gt;%req_method(&#34;POST&#34;) %&gt;%req_body_json(list(identifier = Sys.getenv(&#34;BLUESKY_APP_USER&#34;),password = Sys.getenv(&#34;BLUESKY_APP_PASS&#34;))) %&gt;%req_perform() %&gt;%resp_body_json()# Get your own DID (Decentralized Identifier)self_did &lt;- session$did# Connect to the databasecon &lt;- dbConnect(duckdb::duckdb(), db_path)# Retrieve users with 0 postsusers_with_zero_posts &lt;- dbGetQuery(con,&#34;SELECT handleFROM follow_relationshipsWHERE tag = &#39;wwd-following&#39;AND handle NOT IN (SELECT DISTINCT author_handle FROM posts)&#34;)# Retrieve users with average sentiment score below -5users_with_low_sentiment &lt;- dbGetQuery(con,&#34;SELECT author_handle AS handleFROM wwd_following_average_sentimentWHERE average_sentiment &lt; 5&#34;)# Combine the users to unfollowusers_to_unfollow &lt;- unique(c(users_with_zero_posts$handle,users_with_low_sentiment$handle))# Retrieve the list of users who are following youmessage(&#34;Fetching your followers...&#34;)# Function to get all followersget_all_followers &lt;- function(session, user_did) {all_followers &lt;- list()cursor &lt;- NULLrepeat {req &lt;- request(&#34;https://bsky.social/xrpc/app.bsky.graph.getFollowers&#34;) %&gt;%req_method(&#34;GET&#34;) %&gt;%req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) %&gt;%req_url_query(actor = user_did)if (!is.null(cursor)) {req &lt;- req %&gt;% req_url_query(cursor = cursor)}resp &lt;- req %&gt;%req_error(is_error = function(resp)FALSE) %&gt;%req_perform()if (resp_status(resp) &gt;= 400) {message(&#34;An error occurred fetching followers: &#34;,resp_status_desc(resp))print(resp_body_string(resp))break}data &lt;- resp_body_json(resp)followers &lt;- data$followersif (length(followers) == 0) {break}all_followers &lt;- c(all_followers, followers)if (!is.null(data$cursor)) {cursor &lt;- data$cursor} else {break}Sys.sleep(0.1) # Pause to respect rate limits}# Process the followers into a tibblefollowers_df &lt;- map_dfr(all_followers, function(user) {tibble(did = user$did,handle = user$handle,displayName = user$displayName %||% NA_character_,description = user$description %||% NA_character_,createdAt = user$createdAt %||% NA_character_)})return(followers_df)}# Get your followersfollowers_df &lt;- get_all_followers(session, self_did)# Exclude users who are following you from users_to_unfollowfollowers_handles &lt;- followers_df$handleusers_to_unfollow &lt;- setdiff(users_to_unfollow, followers_handles)# If there are no users to unfollow after exclusion, exit the functionif (length(users_to_unfollow) == 0) {message(&#34;No users meet the criteria for unfollowing after excluding followers.&#34;)dbDisconnect(con, shutdown = TRUE)return(NULL)}# Fetch your follow records to get the rkey (record key)message(&#34;Fetching your follow records...&#34;)get_follow_records &lt;- function(session, repo_did) {all_records &lt;- list()cursor &lt;- NULLrepeat {req &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.repo.listRecords&#34;) %&gt;%req_method(&#34;GET&#34;) %&gt;%req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) %&gt;%req_url_query(repo = repo_did,collection = &#34;app.bsky.graph.follow&#34;,limit = 100)if (!is.null(cursor)) {req &lt;- req %&gt;% req_url_query(cursor = cursor)}resp &lt;- req %&gt;%req_error(is_error = function(resp)FALSE) %&gt;%req_perform()if (resp_status(resp) &gt;= 400) {message(&#34;An error occurred fetching follow records: &#34;,resp_status_desc(resp))print(resp_body_string(resp))break}data &lt;- resp_body_json(resp)records &lt;- data$recordsif (length(records) == 0) {break}all_records &lt;- c(all_records, records)if (!is.null(data$cursor)) {cursor &lt;- data$cursor} else {break}Sys.sleep(0.1) # Pause to respect rate limits}# Process the records into a tibblerecords_df &lt;- map_dfr(all_records, function(record) {tibble(uri = record$uri,rkey = record$uri %&gt;% basename(),cid = record$cid,createdAt = record$value$createdAt %||% NA_character_,subject_did = record$value$subject %||% NA_character_)})return(records_df)}# Get your follow recordsfollow_records_df &lt;- get_follow_records(session, self_did)# Get the mapping of DIDs to handles from the databasedid_handle_map &lt;- dbGetQuery(con,&#34;SELECT did, handleFROM follow_relationshipsWHERE did IS NOT NULL AND handle IS NOT NULL&#34;)# Merge handles into follow_records_dffollow_records_df &lt;- follow_records_df %&gt;%left_join(did_handle_map, by = c(&#34;subject_did&#34; = &#34;did&#34;))# For any DIDs not found in the database, optionally resolve them via API (if necessary)missing_handles &lt;- follow_records_df %&gt;%filter(is.na(handle)) %&gt;%distinct(subject_did)if (nrow(missing_handles) &gt; 0) {message(&#34;Resolving missing DIDs to handles via API...&#34;)resolve_dids_to_handles &lt;- function(dids) {handles &lt;- c()for (did in dids) {req &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.identity.resolveHandle&#34;) %&gt;%req_method(&#34;GET&#34;) %&gt;%req_url_query(did = did)resp &lt;- req %&gt;%req_error(is_error = function(resp)FALSE) %&gt;%req_perform()if (resp_status(resp) == 200) {data &lt;- resp_body_json(resp)handles &lt;- c(handles, data$handle)} else {handles &lt;- c(handles, NA_character_)}Sys.sleep(0.1)}return(handles)}# Resolve missing DIDsresolved_handles &lt;- resolve_dids_to_handles(missing_handles$subject_did)resolved_map &lt;- tibble(subject_did = missing_handles$subject_did, handle = resolved_handles)# Update follow_records_df with resolved handlesfollow_records_df &lt;- follow_records_df %&gt;%left_join(resolved_map,by = &#34;subject_did&#34;,suffix = c(&#34;&#34;, &#34;.resolved&#34;)) %&gt;%mutate(handle = coalesce(handle, handle.resolved)) %&gt;%select(-handle.resolved)}# Find the records corresponding to users_to_unfollowrecords_to_delete &lt;- follow_records_df %&gt;%filter(handle %in% users_to_unfollow)# If there are no matching records, exit the functionif (nrow(records_to_delete) == 0) {message(&#34;No matching follow records found to unfollow.&#34;)dbDisconnect(con, shutdown = TRUE)return(NULL)}# Function to unfollow a user by deleting the follow recordunfollow_user &lt;- function(session, repo_did, rkey) {req &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.repo.deleteRecord&#34;) %&gt;%req_method(&#34;POST&#34;) %&gt;%req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) %&gt;%req_body_json(list(collection = &#34;app.bsky.graph.follow&#34;,repo = repo_did,rkey = rkey))resp &lt;- req %&gt;%req_error(is_error = function(resp)FALSE) %&gt;%req_perform()if (resp_status(resp) &gt;= 400) {message(&#34;Failed to unfollow rkey &#34;,rkey,&#34;: &#34;,resp_status_desc(resp))print(resp_body_string(resp))} else {message(&#34;Successfully unfollowed rkey &#34;, rkey)}}# Unfollow each usermessage(&#34;Unfollowing users who meet the criteria...&#34;)for (i in seq_len(nrow(records_to_delete))) {rkey &lt;- records_to_delete$rkey[i]handle &lt;- records_to_delete$handle[i]message(&#34;Unfollowing user: &#34;, handle)unfollow_user(session, self_did, rkey)Sys.sleep(0.1) # Pause to respect rate limits}# Disconnect from the databasedbDisconnect(con, shutdown = TRUE)message(&#34;Unfollowing process completed.&#34;)}# Run the functionunfollow_users_based_on_criteria(db_path)# Function to create a histogram of average sentiment scores of remaining followscreate_histogram_of_avg_sentiment &lt;- function(db_path) {# Connect to the databasecon &lt;- dbConnect(duckdb::duckdb(), db_path)# Retrieve the list of users you are currently followingfollows_df &lt;- dbGetQuery(con,&#34;SELECT * FROM follow_relationships WHERE tag = &#39;wwd-following&#39;&#34;)# Retrieve the average sentiment scoresavg_sentiment_df &lt;- dbGetQuery(con,&#34;SELECT author_handle AS handle, average_sentiment FROM wwd_following_average_sentiment&#34;)# Merge the data to get the average sentiment scores of your current followsmerged_df &lt;- follows_df %&gt;%inner_join(avg_sentiment_df, by = &#34;handle&#34;)# Disconnect from the databasedbDisconnect(con, shutdown = TRUE)# Check if there are any data to plotif (nrow(merged_df) == 0) {message(&#34;No data available to plot.&#34;)return(NULL)}# Plot the histogramggplot(merged_df, aes(x = average_sentiment)) &#43;geom_histogram(binwidth = 1,fill = &#34;steelblue&#34;,color = &#34;black&#34;) &#43;labs(title = &#34;Histogram of Average Sentiment Scores of Remaining Follows&#34;, x = &#34;Average Sentiment Score&#34;, y = &#34;Number of Users&#34;) &#43;theme_minimal()}# Run the function to create the histogramcreate_histogram_of_avg_sentiment(db_path)">
  <meta itemprop="wordCount" content="2525">
  
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RJ8HKRJ16Q"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RJ8HKRJ16Q');
        }
      </script>
  <!--[if IE]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
  
  
  <link rel="stylesheet" href="/style.main.min.0820a865770f259724d61d170adbb19db040647ecaa3b2023c16f04ada7fc7d2.css" integrity="sha256-CCCoZXcPJZck1h0XCtuxnbBAZH7Ko7ICPBbwStp/x9I=" media="screen">
  
  
  <script src="/panelset.min.ed1ac24b6e16f4e2481e3d1d098ae66f5bc77438aef619e6e266d8ac5b00dc72.js" type="text/javascript"></script>
  
  
  <script src="/main.min.f0b39b51e43cf3881368fb093708a9d3b3499e674af4b4e47e27e512a5d411e2.js" type="text/javascript"></script>
</head>
<body>
      <div class="grid-container">
<header class="site-header pt4 pb2 mb4 bb b--transparent ph5 headroom z-max" role="banner">
  <nav class="site-nav db dt-l w-100" role="navigation">
    <a class="site-brand db dtc-l v-mid link no-underline w-100 w-33-l tc tl-l" href="http://localhost:4321/" title="Home">
      <img src="/img/logo_leaf.png" class="dib db-l h2 w-auto" alt="Warp and Weft Data">
    </a>
    <div class="site-links db dtc-l v-mid w-100 w-47-l tc tr-l mt3 mt0-l ttu tracked">
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 " href="/about/" title="About Steve Ewing">About</a>
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 active" href="/blog/" title="Blog">Blog</a>
      
      
    </div>
  </nav>
</header>

<main class="page-main pa4" role="main">
  <section class="page-content mw7 center">
    <article class="post-content pa0 ph4-l">
      <header class="post-header">
        <h1 class="f1 lh-solid measure-narrow mb3 fw4"></h1>
        
        <p class="f6 measure lh-copy mv1">By Steve Ewing</p>
        <p class="f7 db mv0 ttu">January 1, 0001</p>

      

      </header>
      <section class="post-body pt5 pb4">
        <p>I followed a ton of people using the new starter packs. Now I’m going to keep all my mutuals and unfollow the people I’m following who aren’t following me back and who have a net negative sentiment score on their posts.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(duckdb)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">library</span>(parsedate)  </span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>get_follow_relationships <span class="ot">&lt;-</span> <span class="cf">function</span>(db_path) {</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>  <span class="fu">library</span>(tidyverse)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  <span class="fu">library</span>(httr2)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  <span class="fu">library</span>(DBI)</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>  <span class="fu">library</span>(duckdb)</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  </span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  <span class="co"># Create a logged-in API session object</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  session <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">&quot;https://bsky.social/xrpc/com.atproto.server.createSession&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>    <span class="fu">req_method</span>(<span class="st">&quot;POST&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>    <span class="fu">req_body_json</span>(<span class="fu">list</span>(</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>      <span class="at">identifier =</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;BLUESKY_APP_USER&quot;</span>),</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>      <span class="at">password =</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;BLUESKY_APP_PASS&quot;</span>)</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>    )) <span class="sc">|&gt;</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>    <span class="fu">req_perform</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>    <span class="fu">resp_body_json</span>()</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>  </span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>  <span class="co"># Get your own DID (Decentralized Identifier)</span></span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>  self_handle <span class="ot">&lt;-</span> session<span class="sc">$</span>handle</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>  self_did <span class="ot">&lt;-</span> session<span class="sc">$</span>did</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>  </span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>  <span class="co"># Function to get all follows or followers</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>  get_all_follows <span class="ot">&lt;-</span> <span class="cf">function</span>(endpoint_url, user_did) {</span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>    all_users <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a>    cursor <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a>    </span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a>      req <span class="ot">&lt;-</span> <span class="fu">request</span>(endpoint_url) <span class="sc">|&gt;</span></span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a>        <span class="fu">req_method</span>(<span class="st">&quot;GET&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a>        <span class="fu">req_headers</span>(<span class="at">Authorization =</span> <span class="fu">paste0</span>(<span class="st">&quot;Bearer &quot;</span>, session<span class="sc">$</span>accessJwt)) <span class="sc">|&gt;</span></span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a>        <span class="fu">req_url_query</span>(<span class="at">actor =</span> user_did)</span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a>      </span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cursor)) {</span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a>        req <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span> <span class="fu">req_url_query</span>(<span class="at">cursor =</span> cursor)</span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a>      }</span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a>      </span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a>      resp <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span></span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a>        <span class="fu">req_error</span>(</span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a>          <span class="at">is_error =</span> <span class="cf">function</span>(resp)</span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a>            <span class="cn">FALSE</span></span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a>        <span class="fu">req_perform</span>()</span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a>      </span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">resp_status</span>(resp) <span class="sc">&gt;=</span> <span class="dv">400</span>) {</span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;An error occurred fetching data: &quot;</span>,</span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a>                <span class="fu">resp_status_desc</span>(resp))</span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">resp_body_string</span>(resp))</span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a>      }</span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a>      </span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a>      data <span class="ot">&lt;-</span> <span class="fu">resp_body_json</span>(resp)</span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a>      </span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a>      <span class="co"># Determine if fetching followers or following</span></span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">&quot;followers&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(data)) {</span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a>        users <span class="ot">&lt;-</span> data<span class="sc">$</span>followers</span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (<span class="st">&quot;follows&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(data)) {</span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a>        users <span class="ot">&lt;-</span> data<span class="sc">$</span>follows</span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;Unexpected data format.&quot;</span>)</span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a>      }</span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a>      </span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a>      <span class="co"># Check if users list is empty</span></span>
<span id="cb1-71"><a href="#cb1-71" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(users) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb1-72"><a href="#cb1-72" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb1-73"><a href="#cb1-73" tabindex="-1"></a>      }</span>
<span id="cb1-74"><a href="#cb1-74" tabindex="-1"></a>      </span>
<span id="cb1-75"><a href="#cb1-75" tabindex="-1"></a>      all_users <span class="ot">&lt;-</span> <span class="fu">c</span>(all_users, users)</span>
<span id="cb1-76"><a href="#cb1-76" tabindex="-1"></a>      </span>
<span id="cb1-77"><a href="#cb1-77" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(data<span class="sc">$</span>cursor)) {</span>
<span id="cb1-78"><a href="#cb1-78" tabindex="-1"></a>        cursor <span class="ot">&lt;-</span> data<span class="sc">$</span>cursor</span>
<span id="cb1-79"><a href="#cb1-79" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb1-80"><a href="#cb1-80" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb1-81"><a href="#cb1-81" tabindex="-1"></a>      }</span>
<span id="cb1-82"><a href="#cb1-82" tabindex="-1"></a>      </span>
<span id="cb1-83"><a href="#cb1-83" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="fl">0.1</span>) <span class="co"># Pause to respect rate limits</span></span>
<span id="cb1-84"><a href="#cb1-84" tabindex="-1"></a>    }</span>
<span id="cb1-85"><a href="#cb1-85" tabindex="-1"></a>    </span>
<span id="cb1-86"><a href="#cb1-86" tabindex="-1"></a>    <span class="co"># Process the users into a tibble</span></span>
<span id="cb1-87"><a href="#cb1-87" tabindex="-1"></a>    users_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(all_users, <span class="cf">function</span>(user) {</span>
<span id="cb1-88"><a href="#cb1-88" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb1-89"><a href="#cb1-89" tabindex="-1"></a>        <span class="at">did =</span> user<span class="sc">$</span>did,</span>
<span id="cb1-90"><a href="#cb1-90" tabindex="-1"></a>        <span class="at">handle =</span> user<span class="sc">$</span>handle,</span>
<span id="cb1-91"><a href="#cb1-91" tabindex="-1"></a>        <span class="at">displayName =</span> user<span class="sc">$</span>displayName <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb1-92"><a href="#cb1-92" tabindex="-1"></a>        <span class="at">description =</span> user<span class="sc">$</span>description <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb1-93"><a href="#cb1-93" tabindex="-1"></a>        <span class="at">createdAt =</span> user<span class="sc">$</span>createdAt <span class="sc">%||%</span> <span class="cn">NA_character_</span></span>
<span id="cb1-94"><a href="#cb1-94" tabindex="-1"></a>      )</span>
<span id="cb1-95"><a href="#cb1-95" tabindex="-1"></a>    })</span>
<span id="cb1-96"><a href="#cb1-96" tabindex="-1"></a>    </span>
<span id="cb1-97"><a href="#cb1-97" tabindex="-1"></a>    <span class="fu">return</span>(users_df)</span>
<span id="cb1-98"><a href="#cb1-98" tabindex="-1"></a>  }</span>
<span id="cb1-99"><a href="#cb1-99" tabindex="-1"></a>  </span>
<span id="cb1-100"><a href="#cb1-100" tabindex="-1"></a>  <span class="co"># Get followers</span></span>
<span id="cb1-101"><a href="#cb1-101" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Fetching your followers...&quot;</span>)</span>
<span id="cb1-102"><a href="#cb1-102" tabindex="-1"></a>  followers_df <span class="ot">&lt;-</span> <span class="fu">get_all_follows</span>(<span class="st">&quot;https://bsky.social/xrpc/app.bsky.graph.getFollowers&quot;</span>,</span>
<span id="cb1-103"><a href="#cb1-103" tabindex="-1"></a>                                  self_did)</span>
<span id="cb1-104"><a href="#cb1-104" tabindex="-1"></a>  </span>
<span id="cb1-105"><a href="#cb1-105" tabindex="-1"></a>  <span class="co"># Get following</span></span>
<span id="cb1-106"><a href="#cb1-106" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Fetching users you are following...&quot;</span>)</span>
<span id="cb1-107"><a href="#cb1-107" tabindex="-1"></a>  following_df <span class="ot">&lt;-</span> <span class="fu">get_all_follows</span>(<span class="st">&quot;https://bsky.social/xrpc/app.bsky.graph.getFollows&quot;</span>,</span>
<span id="cb1-108"><a href="#cb1-108" tabindex="-1"></a>                                  self_did)</span>
<span id="cb1-109"><a href="#cb1-109" tabindex="-1"></a>  </span>
<span id="cb1-110"><a href="#cb1-110" tabindex="-1"></a>  <span class="co"># Identify relationships</span></span>
<span id="cb1-111"><a href="#cb1-111" tabindex="-1"></a>  followers_handles <span class="ot">&lt;-</span> followers_df<span class="sc">$</span>handle</span>
<span id="cb1-112"><a href="#cb1-112" tabindex="-1"></a>  following_handles <span class="ot">&lt;-</span> following_df<span class="sc">$</span>handle</span>
<span id="cb1-113"><a href="#cb1-113" tabindex="-1"></a>  </span>
<span id="cb1-114"><a href="#cb1-114" tabindex="-1"></a>  <span class="co"># Users you are following who aren&#39;t following you back</span></span>
<span id="cb1-115"><a href="#cb1-115" tabindex="-1"></a>  wwd_following <span class="ot">&lt;-</span> following_df <span class="sc">%&gt;%</span></span>
<span id="cb1-116"><a href="#cb1-116" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>handle <span class="sc">%in%</span> followers_handles) <span class="sc">%&gt;%</span></span>
<span id="cb1-117"><a href="#cb1-117" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tag =</span> <span class="st">&quot;wwd-following&quot;</span>)</span>
<span id="cb1-118"><a href="#cb1-118" tabindex="-1"></a>  </span>
<span id="cb1-119"><a href="#cb1-119" tabindex="-1"></a>  <span class="co"># Users who are following you but you aren&#39;t following back</span></span>
<span id="cb1-120"><a href="#cb1-120" tabindex="-1"></a>  wwd_follower <span class="ot">&lt;-</span> followers_df <span class="sc">%&gt;%</span></span>
<span id="cb1-121"><a href="#cb1-121" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>handle <span class="sc">%in%</span> following_handles) <span class="sc">%&gt;%</span></span>
<span id="cb1-122"><a href="#cb1-122" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tag =</span> <span class="st">&quot;wwd-follower&quot;</span>)</span>
<span id="cb1-123"><a href="#cb1-123" tabindex="-1"></a>  </span>
<span id="cb1-124"><a href="#cb1-124" tabindex="-1"></a>  <span class="co"># Mutual follows</span></span>
<span id="cb1-125"><a href="#cb1-125" tabindex="-1"></a>  wwd_mutuals <span class="ot">&lt;-</span> following_df <span class="sc">%&gt;%</span></span>
<span id="cb1-126"><a href="#cb1-126" tabindex="-1"></a>    <span class="fu">filter</span>(handle <span class="sc">%in%</span> followers_handles) <span class="sc">%&gt;%</span></span>
<span id="cb1-127"><a href="#cb1-127" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tag =</span> <span class="st">&quot;wwd-mutuals&quot;</span>)</span>
<span id="cb1-128"><a href="#cb1-128" tabindex="-1"></a>  </span>
<span id="cb1-129"><a href="#cb1-129" tabindex="-1"></a>  <span class="co"># Combine all</span></span>
<span id="cb1-130"><a href="#cb1-130" tabindex="-1"></a>  relationships_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(wwd_following, wwd_follower, wwd_mutuals)</span>
<span id="cb1-131"><a href="#cb1-131" tabindex="-1"></a>  </span>
<span id="cb1-132"><a href="#cb1-132" tabindex="-1"></a>  <span class="co"># Connect to the database</span></span>
<span id="cb1-133"><a href="#cb1-133" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), db_path)</span>
<span id="cb1-134"><a href="#cb1-134" tabindex="-1"></a>  </span>
<span id="cb1-135"><a href="#cb1-135" tabindex="-1"></a>  <span class="co"># Save relationships to the database</span></span>
<span id="cb1-136"><a href="#cb1-136" tabindex="-1"></a>  <span class="fu">dbWriteTable</span>(con, <span class="st">&quot;follow_relationships&quot;</span>, relationships_df, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-137"><a href="#cb1-137" tabindex="-1"></a>  </span>
<span id="cb1-138"><a href="#cb1-138" tabindex="-1"></a>  <span class="co"># Disconnect from the database</span></span>
<span id="cb1-139"><a href="#cb1-139" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-140"><a href="#cb1-140" tabindex="-1"></a>  </span>
<span id="cb1-141"><a href="#cb1-141" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Follow relationships have been stored in the database.&quot;</span>)</span>
<span id="cb1-142"><a href="#cb1-142" tabindex="-1"></a>  </span>
<span id="cb1-143"><a href="#cb1-143" tabindex="-1"></a>  <span class="co"># Return the data frame</span></span>
<span id="cb1-144"><a href="#cb1-144" tabindex="-1"></a>  <span class="fu">return</span>(relationships_df)</span>
<span id="cb1-145"><a href="#cb1-145" tabindex="-1"></a>}</span>
<span id="cb1-146"><a href="#cb1-146" tabindex="-1"></a></span>
<span id="cb1-147"><a href="#cb1-147" tabindex="-1"></a><span class="co"># Define the path to your database</span></span>
<span id="cb1-148"><a href="#cb1-148" tabindex="-1"></a>db_path <span class="ot">&lt;-</span> <span class="st">&quot;C:/Users/steph/OneDrive/warp_and_weft_data/content/blog/bsky_sentiment_index/bluesky_data.duckdb&quot;</span></span>
<span id="cb1-149"><a href="#cb1-149" tabindex="-1"></a></span>
<span id="cb1-150"><a href="#cb1-150" tabindex="-1"></a><span class="co"># Call the function with the database path</span></span>
<span id="cb1-151"><a href="#cb1-151" tabindex="-1"></a>relationships <span class="ot">&lt;-</span> <span class="fu">get_follow_relationships</span>(db_path)</span>
<span id="cb1-152"><a href="#cb1-152" tabindex="-1"></a></span>
<span id="cb1-153"><a href="#cb1-153" tabindex="-1"></a><span class="co"># View the results</span></span>
<span id="cb1-154"><a href="#cb1-154" tabindex="-1"></a><span class="fu">print</span>(relationships)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Function to get posts from a vector of handles, fetching only new posts and writing to db as it fetches</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>get_posts_from_handles <span class="ot">&lt;-</span> <span class="cf">function</span>(handles, session, db_path) {</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="co"># Load parsedate library</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="fu">library</span>(parsedate)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  </span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>  <span class="co"># Connect to the database</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), db_path)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>  </span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>  <span class="co"># Loop over each handle</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>  <span class="cf">for</span> (handle <span class="cf">in</span> handles) {</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Fetching posts for handle: &quot;</span>, handle)</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    <span class="co"># Get the latest record_createdAt for this handle from the posts table</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>    latest_time_query <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>      <span class="st">&quot;SELECT MAX(record_createdAt) as latest_time FROM posts WHERE author_handle = &#39;%s&#39;&quot;</span>,</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>      handle</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>    )</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>    latest_time_result <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, latest_time_query)</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    latest_time <span class="ot">&lt;-</span> latest_time_result<span class="sc">$</span>latest_time[<span class="dv">1</span>]</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    </span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>    <span class="co"># If there is no latest_time (i.e., no posts for this handle), set to NULL</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(latest_time) <span class="sc">||</span> <span class="fu">is.null</span>(latest_time)) {</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>      latest_time <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;No existing posts found for handle: &quot;</span>, handle)</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;Latest post time for &quot;</span>, handle, <span class="st">&quot;: &quot;</span>, latest_time)</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>    }</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>    </span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>    <span class="co"># Initialize variables for fetching posts</span></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>    <span class="co"># We will process and write posts as we fetch them</span></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a>    cursor <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a>    keep_fetching <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>    </span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>      <span class="co"># Construct the GET request</span></span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>      req <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">&quot;https://bsky.social/xrpc/app.bsky.feed.getAuthorFeed&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a>        <span class="fu">req_method</span>(<span class="st">&quot;GET&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a>        <span class="fu">req_headers</span>(<span class="at">Authorization =</span> <span class="fu">paste0</span>(<span class="st">&quot;Bearer &quot;</span>, session<span class="sc">$</span>accessJwt)) <span class="sc">|&gt;</span></span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a>        <span class="fu">req_url_query</span>(<span class="at">actor =</span> handle)</span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a>      </span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a>      <span class="co"># If cursor is not NULL, add it to the query</span></span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cursor)) {</span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a>        req <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span> <span class="fu">req_url_query</span>(<span class="at">cursor =</span> cursor)</span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a>      }</span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a>      </span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a>      <span class="co"># Perform the request</span></span>
<span id="cb2-47"><a href="#cb2-47" tabindex="-1"></a>      resp <span class="ot">&lt;-</span> req <span class="sc">|&gt;</span></span>
<span id="cb2-48"><a href="#cb2-48" tabindex="-1"></a>        <span class="fu">req_error</span>(</span>
<span id="cb2-49"><a href="#cb2-49" tabindex="-1"></a>          <span class="at">is_error =</span> <span class="cf">function</span>(resp)</span>
<span id="cb2-50"><a href="#cb2-50" tabindex="-1"></a>            <span class="cn">FALSE</span></span>
<span id="cb2-51"><a href="#cb2-51" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb2-52"><a href="#cb2-52" tabindex="-1"></a>        <span class="fu">req_perform</span>()</span>
<span id="cb2-53"><a href="#cb2-53" tabindex="-1"></a>      </span>
<span id="cb2-54"><a href="#cb2-54" tabindex="-1"></a>      <span class="co"># Check if the response is an error</span></span>
<span id="cb2-55"><a href="#cb2-55" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">resp_status</span>(resp) <span class="sc">&gt;=</span> <span class="dv">400</span>) {</span>
<span id="cb2-56"><a href="#cb2-56" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;An error occurred fetching posts for &quot;</span>,</span>
<span id="cb2-57"><a href="#cb2-57" tabindex="-1"></a>                handle,</span>
<span id="cb2-58"><a href="#cb2-58" tabindex="-1"></a>                <span class="st">&quot;: &quot;</span>,</span>
<span id="cb2-59"><a href="#cb2-59" tabindex="-1"></a>                <span class="fu">resp_status_desc</span>(resp))</span>
<span id="cb2-60"><a href="#cb2-60" tabindex="-1"></a>        <span class="co"># Optionally, print the response body for more details</span></span>
<span id="cb2-61"><a href="#cb2-61" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">resp_body_string</span>(resp))</span>
<span id="cb2-62"><a href="#cb2-62" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb2-63"><a href="#cb2-63" tabindex="-1"></a>      }</span>
<span id="cb2-64"><a href="#cb2-64" tabindex="-1"></a>      </span>
<span id="cb2-65"><a href="#cb2-65" tabindex="-1"></a>      <span class="co"># Parse the response</span></span>
<span id="cb2-66"><a href="#cb2-66" tabindex="-1"></a>      feed_data <span class="ot">&lt;-</span> <span class="fu">resp_body_json</span>(resp)</span>
<span id="cb2-67"><a href="#cb2-67" tabindex="-1"></a>      </span>
<span id="cb2-68"><a href="#cb2-68" tabindex="-1"></a>      <span class="co"># Check if feed is empty</span></span>
<span id="cb2-69"><a href="#cb2-69" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(feed_data<span class="sc">$</span>feed) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb2-70"><a href="#cb2-70" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;No posts found for handle: &quot;</span>, handle)</span>
<span id="cb2-71"><a href="#cb2-71" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb2-72"><a href="#cb2-72" tabindex="-1"></a>      }</span>
<span id="cb2-73"><a href="#cb2-73" tabindex="-1"></a>      </span>
<span id="cb2-74"><a href="#cb2-74" tabindex="-1"></a>      <span class="co"># Process posts and check timestamps</span></span>
<span id="cb2-75"><a href="#cb2-75" tabindex="-1"></a>      posts_to_add <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb2-76"><a href="#cb2-76" tabindex="-1"></a>      <span class="cf">for</span> (post <span class="cf">in</span> feed_data<span class="sc">$</span>feed) {</span>
<span id="cb2-77"><a href="#cb2-77" tabindex="-1"></a>        post_time <span class="ot">&lt;-</span> post<span class="sc">$</span>post<span class="sc">$</span>record<span class="sc">$</span>createdAt <span class="sc">%||%</span> <span class="st">&quot;&quot;</span></span>
<span id="cb2-78"><a href="#cb2-78" tabindex="-1"></a>        <span class="cf">if</span> (post_time <span class="sc">==</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb2-79"><a href="#cb2-79" tabindex="-1"></a>          <span class="cf">next</span>  <span class="co"># Skip if no timestamp</span></span>
<span id="cb2-80"><a href="#cb2-80" tabindex="-1"></a>        </span>
<span id="cb2-81"><a href="#cb2-81" tabindex="-1"></a>        <span class="co"># Parse the timestamps using parsedate::parse_iso_8601</span></span>
<span id="cb2-82"><a href="#cb2-82" tabindex="-1"></a>        post_time_parsed <span class="ot">&lt;-</span> <span class="fu">parse_iso_8601</span>(post_time)</span>
<span id="cb2-83"><a href="#cb2-83" tabindex="-1"></a>        latest_time_parsed <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(latest_time))</span>
<span id="cb2-84"><a href="#cb2-84" tabindex="-1"></a>          <span class="fu">parse_iso_8601</span>(latest_time)</span>
<span id="cb2-85"><a href="#cb2-85" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb2-86"><a href="#cb2-86" tabindex="-1"></a>          <span class="cn">NULL</span></span>
<span id="cb2-87"><a href="#cb2-87" tabindex="-1"></a>        </span>
<span id="cb2-88"><a href="#cb2-88" tabindex="-1"></a>        <span class="co"># Compare post_time with latest_time</span></span>
<span id="cb2-89"><a href="#cb2-89" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(latest_time_parsed) <span class="sc">&amp;&amp;</span></span>
<span id="cb2-90"><a href="#cb2-90" tabindex="-1"></a>            <span class="sc">!</span><span class="fu">is.na</span>(post_time_parsed) <span class="sc">&amp;&amp;</span></span>
<span id="cb2-91"><a href="#cb2-91" tabindex="-1"></a>            post_time_parsed <span class="sc">&lt;=</span> latest_time_parsed) {</span>
<span id="cb2-92"><a href="#cb2-92" tabindex="-1"></a>          <span class="co"># Reached posts we&#39;ve already fetched</span></span>
<span id="cb2-93"><a href="#cb2-93" tabindex="-1"></a>          keep_fetching <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb2-94"><a href="#cb2-94" tabindex="-1"></a>          <span class="cf">break</span></span>
<span id="cb2-95"><a href="#cb2-95" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb2-96"><a href="#cb2-96" tabindex="-1"></a>          <span class="co"># New post, add to the list</span></span>
<span id="cb2-97"><a href="#cb2-97" tabindex="-1"></a>          posts_to_add <span class="ot">&lt;-</span> <span class="fu">c</span>(posts_to_add, <span class="fu">list</span>(post))</span>
<span id="cb2-98"><a href="#cb2-98" tabindex="-1"></a>        }</span>
<span id="cb2-99"><a href="#cb2-99" tabindex="-1"></a>      }</span>
<span id="cb2-100"><a href="#cb2-100" tabindex="-1"></a>      </span>
<span id="cb2-101"><a href="#cb2-101" tabindex="-1"></a>      <span class="co"># If there are new posts to add, process and write them to the database</span></span>
<span id="cb2-102"><a href="#cb2-102" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(posts_to_add) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-103"><a href="#cb2-103" tabindex="-1"></a>        posts_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(posts_to_add, <span class="cf">function</span>(post) {</span>
<span id="cb2-104"><a href="#cb2-104" tabindex="-1"></a>          <span class="fu">tibble</span>(</span>
<span id="cb2-105"><a href="#cb2-105" tabindex="-1"></a>            <span class="at">uri =</span> post<span class="sc">$</span>post<span class="sc">$</span>uri,</span>
<span id="cb2-106"><a href="#cb2-106" tabindex="-1"></a>            <span class="at">cid =</span> post<span class="sc">$</span>post<span class="sc">$</span>cid,</span>
<span id="cb2-107"><a href="#cb2-107" tabindex="-1"></a>            <span class="at">author_did =</span> post<span class="sc">$</span>post<span class="sc">$</span>author<span class="sc">$</span>did <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-108"><a href="#cb2-108" tabindex="-1"></a>            <span class="at">author_handle =</span> post<span class="sc">$</span>post<span class="sc">$</span>author<span class="sc">$</span>handle <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-109"><a href="#cb2-109" tabindex="-1"></a>            <span class="at">author_displayName =</span> post<span class="sc">$</span>post<span class="sc">$</span>author<span class="sc">$</span>displayName <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-110"><a href="#cb2-110" tabindex="-1"></a>            <span class="at">record_type =</span> post<span class="sc">$</span>post<span class="sc">$</span>record<span class="sc">$</span><span class="st">`</span><span class="at">$type</span><span class="st">`</span> <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-111"><a href="#cb2-111" tabindex="-1"></a>            <span class="at">record_text =</span> post<span class="sc">$</span>post<span class="sc">$</span>record<span class="sc">$</span>text <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-112"><a href="#cb2-112" tabindex="-1"></a>            <span class="at">record_createdAt =</span> post<span class="sc">$</span>post<span class="sc">$</span>record<span class="sc">$</span>createdAt <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-113"><a href="#cb2-113" tabindex="-1"></a>            <span class="at">reply_root =</span> post<span class="sc">$</span>post<span class="sc">$</span>record<span class="sc">$</span>reply<span class="sc">$</span>root<span class="sc">$</span>uri <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-114"><a href="#cb2-114" tabindex="-1"></a>            <span class="at">reply_parent =</span> post<span class="sc">$</span>post<span class="sc">$</span>record<span class="sc">$</span>reply<span class="sc">$</span>parent<span class="sc">$</span>uri <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb2-115"><a href="#cb2-115" tabindex="-1"></a>            <span class="at">repost_count =</span> post<span class="sc">$</span>post<span class="sc">$</span>repostCount <span class="sc">%||%</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb2-116"><a href="#cb2-116" tabindex="-1"></a>            <span class="at">reply_count =</span> post<span class="sc">$</span>post<span class="sc">$</span>replyCount <span class="sc">%||%</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb2-117"><a href="#cb2-117" tabindex="-1"></a>            <span class="at">like_count =</span> post<span class="sc">$</span>post<span class="sc">$</span>likeCount <span class="sc">%||%</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb2-118"><a href="#cb2-118" tabindex="-1"></a>            <span class="at">indexed_at =</span> post<span class="sc">$</span>post<span class="sc">$</span>indexedAt <span class="sc">%||%</span> <span class="cn">NA_character_</span></span>
<span id="cb2-119"><a href="#cb2-119" tabindex="-1"></a>          )</span>
<span id="cb2-120"><a href="#cb2-120" tabindex="-1"></a>        })</span>
<span id="cb2-121"><a href="#cb2-121" tabindex="-1"></a>        </span>
<span id="cb2-122"><a href="#cb2-122" tabindex="-1"></a>        <span class="co"># Write the new posts to the &#39;posts&#39; table, appending</span></span>
<span id="cb2-123"><a href="#cb2-123" tabindex="-1"></a>        <span class="fu">dbWriteTable</span>(con, <span class="st">&quot;posts&quot;</span>, posts_df, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-124"><a href="#cb2-124" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;Wrote &quot;</span>, <span class="fu">nrow</span>(posts_df), <span class="st">&quot; new posts for handle: &quot;</span>, handle)</span>
<span id="cb2-125"><a href="#cb2-125" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb2-126"><a href="#cb2-126" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;No new posts to add for handle: &quot;</span>, handle)</span>
<span id="cb2-127"><a href="#cb2-127" tabindex="-1"></a>      }</span>
<span id="cb2-128"><a href="#cb2-128" tabindex="-1"></a>      </span>
<span id="cb2-129"><a href="#cb2-129" tabindex="-1"></a>      <span class="co"># Break the loop if we&#39;ve reached existing posts</span></span>
<span id="cb2-130"><a href="#cb2-130" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span>keep_fetching) {</span>
<span id="cb2-131"><a href="#cb2-131" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb2-132"><a href="#cb2-132" tabindex="-1"></a>      }</span>
<span id="cb2-133"><a href="#cb2-133" tabindex="-1"></a>      </span>
<span id="cb2-134"><a href="#cb2-134" tabindex="-1"></a>      <span class="co"># Update cursor</span></span>
<span id="cb2-135"><a href="#cb2-135" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(feed_data<span class="sc">$</span>cursor)) {</span>
<span id="cb2-136"><a href="#cb2-136" tabindex="-1"></a>        cursor <span class="ot">&lt;-</span> feed_data<span class="sc">$</span>cursor</span>
<span id="cb2-137"><a href="#cb2-137" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb2-138"><a href="#cb2-138" tabindex="-1"></a>        <span class="co"># No more pages to fetch</span></span>
<span id="cb2-139"><a href="#cb2-139" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb2-140"><a href="#cb2-140" tabindex="-1"></a>      }</span>
<span id="cb2-141"><a href="#cb2-141" tabindex="-1"></a>      </span>
<span id="cb2-142"><a href="#cb2-142" tabindex="-1"></a>      <span class="co"># Optional: Pause to respect rate limits</span></span>
<span id="cb2-143"><a href="#cb2-143" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="fl">0.1</span>)</span>
<span id="cb2-144"><a href="#cb2-144" tabindex="-1"></a>    }</span>
<span id="cb2-145"><a href="#cb2-145" tabindex="-1"></a>  }</span>
<span id="cb2-146"><a href="#cb2-146" tabindex="-1"></a>  </span>
<span id="cb2-147"><a href="#cb2-147" tabindex="-1"></a>  <span class="co"># Disconnect from the database</span></span>
<span id="cb2-148"><a href="#cb2-148" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">FALSE</span>)  <span class="co"># Keep the database running for other operations</span></span>
<span id="cb2-149"><a href="#cb2-149" tabindex="-1"></a>}</span>
<span id="cb2-150"><a href="#cb2-150" tabindex="-1"></a></span>
<span id="cb2-151"><a href="#cb2-151" tabindex="-1"></a><span class="co"># Function to compute sentiment scores for new posts</span></span>
<span id="cb2-152"><a href="#cb2-152" tabindex="-1"></a>compute_sentiment_scores_for_new_posts <span class="ot">&lt;-</span> <span class="cf">function</span>(db_path) {</span>
<span id="cb2-153"><a href="#cb2-153" tabindex="-1"></a>  <span class="fu">library</span>(DBI)</span>
<span id="cb2-154"><a href="#cb2-154" tabindex="-1"></a>  <span class="fu">library</span>(duckdb)</span>
<span id="cb2-155"><a href="#cb2-155" tabindex="-1"></a>  <span class="fu">library</span>(tidyverse)</span>
<span id="cb2-156"><a href="#cb2-156" tabindex="-1"></a>  <span class="fu">library</span>(tidytext)</span>
<span id="cb2-157"><a href="#cb2-157" tabindex="-1"></a>  </span>
<span id="cb2-158"><a href="#cb2-158" tabindex="-1"></a>  <span class="co"># Connect to the database</span></span>
<span id="cb2-159"><a href="#cb2-159" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), db_path)</span>
<span id="cb2-160"><a href="#cb2-160" tabindex="-1"></a>  </span>
<span id="cb2-161"><a href="#cb2-161" tabindex="-1"></a>  <span class="co"># Get the list of uris of posts that already have sentiment scores</span></span>
<span id="cb2-162"><a href="#cb2-162" tabindex="-1"></a>  existing_scores <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">&quot;SELECT uri FROM post_sentiment_scores&quot;</span>)</span>
<span id="cb2-163"><a href="#cb2-163" tabindex="-1"></a>  </span>
<span id="cb2-164"><a href="#cb2-164" tabindex="-1"></a>  <span class="co"># Get the list of uris of all posts</span></span>
<span id="cb2-165"><a href="#cb2-165" tabindex="-1"></a>  all_posts <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">&quot;SELECT uri, record_text FROM posts&quot;</span>)</span>
<span id="cb2-166"><a href="#cb2-166" tabindex="-1"></a>  </span>
<span id="cb2-167"><a href="#cb2-167" tabindex="-1"></a>  <span class="co"># Filter posts that don&#39;t have sentiment scores yet</span></span>
<span id="cb2-168"><a href="#cb2-168" tabindex="-1"></a>  posts_to_score <span class="ot">&lt;-</span> all_posts <span class="sc">%&gt;%</span></span>
<span id="cb2-169"><a href="#cb2-169" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>uri <span class="sc">%in%</span> existing_scores<span class="sc">$</span>uri) <span class="sc">%&gt;%</span></span>
<span id="cb2-170"><a href="#cb2-170" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(record_text))</span>
<span id="cb2-171"><a href="#cb2-171" tabindex="-1"></a>  </span>
<span id="cb2-172"><a href="#cb2-172" tabindex="-1"></a>  <span class="co"># If there are no new posts to score, exit the function</span></span>
<span id="cb2-173"><a href="#cb2-173" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(posts_to_score) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb2-174"><a href="#cb2-174" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;No new posts to compute sentiment scores for.&quot;</span>)</span>
<span id="cb2-175"><a href="#cb2-175" tabindex="-1"></a>    <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-176"><a href="#cb2-176" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb2-177"><a href="#cb2-177" tabindex="-1"></a>  }</span>
<span id="cb2-178"><a href="#cb2-178" tabindex="-1"></a>  </span>
<span id="cb2-179"><a href="#cb2-179" tabindex="-1"></a>  <span class="co"># Tokenize the text</span></span>
<span id="cb2-180"><a href="#cb2-180" tabindex="-1"></a>  posts_tokens <span class="ot">&lt;-</span> posts_to_score <span class="sc">%&gt;%</span></span>
<span id="cb2-181"><a href="#cb2-181" tabindex="-1"></a>    <span class="fu">unnest_tokens</span>(word, record_text)</span>
<span id="cb2-182"><a href="#cb2-182" tabindex="-1"></a>  </span>
<span id="cb2-183"><a href="#cb2-183" tabindex="-1"></a>  <span class="co"># Get the AFINN sentiment lexicon</span></span>
<span id="cb2-184"><a href="#cb2-184" tabindex="-1"></a>  afinn <span class="ot">&lt;-</span> <span class="fu">get_sentiments</span>(<span class="st">&quot;afinn&quot;</span>)</span>
<span id="cb2-185"><a href="#cb2-185" tabindex="-1"></a>  </span>
<span id="cb2-186"><a href="#cb2-186" tabindex="-1"></a>  <span class="co"># Join tokens with sentiment lexicon</span></span>
<span id="cb2-187"><a href="#cb2-187" tabindex="-1"></a>  posts_sentiment <span class="ot">&lt;-</span> posts_tokens <span class="sc">%&gt;%</span></span>
<span id="cb2-188"><a href="#cb2-188" tabindex="-1"></a>    <span class="fu">inner_join</span>(afinn, <span class="at">by =</span> <span class="st">&quot;word&quot;</span>)</span>
<span id="cb2-189"><a href="#cb2-189" tabindex="-1"></a>  </span>
<span id="cb2-190"><a href="#cb2-190" tabindex="-1"></a>  <span class="co"># Compute sentiment score per post</span></span>
<span id="cb2-191"><a href="#cb2-191" tabindex="-1"></a>  post_sentiment_scores <span class="ot">&lt;-</span> posts_sentiment <span class="sc">%&gt;%</span></span>
<span id="cb2-192"><a href="#cb2-192" tabindex="-1"></a>    <span class="fu">group_by</span>(uri) <span class="sc">%&gt;%</span></span>
<span id="cb2-193"><a href="#cb2-193" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">sentiment_score =</span> <span class="fu">sum</span>(value), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>)</span>
<span id="cb2-194"><a href="#cb2-194" tabindex="-1"></a>  </span>
<span id="cb2-195"><a href="#cb2-195" tabindex="-1"></a>  <span class="co"># Handle posts without sentiment words</span></span>
<span id="cb2-196"><a href="#cb2-196" tabindex="-1"></a>  all_uris <span class="ot">&lt;-</span> posts_to_score<span class="sc">$</span>uri</span>
<span id="cb2-197"><a href="#cb2-197" tabindex="-1"></a>  post_sentiment_scores <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">uri =</span> all_uris) <span class="sc">%&gt;%</span></span>
<span id="cb2-198"><a href="#cb2-198" tabindex="-1"></a>    <span class="fu">left_join</span>(post_sentiment_scores, <span class="at">by =</span> <span class="st">&quot;uri&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-199"><a href="#cb2-199" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sentiment_score =</span> <span class="fu">replace_na</span>(sentiment_score, <span class="dv">0</span>))</span>
<span id="cb2-200"><a href="#cb2-200" tabindex="-1"></a>  </span>
<span id="cb2-201"><a href="#cb2-201" tabindex="-1"></a>  <span class="co"># Write the new sentiment scores to the database, appending</span></span>
<span id="cb2-202"><a href="#cb2-202" tabindex="-1"></a>  <span class="fu">dbWriteTable</span>(con,</span>
<span id="cb2-203"><a href="#cb2-203" tabindex="-1"></a>               <span class="st">&quot;post_sentiment_scores&quot;</span>,</span>
<span id="cb2-204"><a href="#cb2-204" tabindex="-1"></a>               post_sentiment_scores,</span>
<span id="cb2-205"><a href="#cb2-205" tabindex="-1"></a>               <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-206"><a href="#cb2-206" tabindex="-1"></a>  </span>
<span id="cb2-207"><a href="#cb2-207" tabindex="-1"></a>  <span class="co"># Disconnect from the database</span></span>
<span id="cb2-208"><a href="#cb2-208" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-209"><a href="#cb2-209" tabindex="-1"></a>  </span>
<span id="cb2-210"><a href="#cb2-210" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Sentiment scores computed for new posts.&quot;</span>)</span>
<span id="cb2-211"><a href="#cb2-211" tabindex="-1"></a>}</span>
<span id="cb2-212"><a href="#cb2-212" tabindex="-1"></a></span>
<span id="cb2-213"><a href="#cb2-213" tabindex="-1"></a><span class="co"># Main script to get posts and compute average sentiment scores</span></span>
<span id="cb2-214"><a href="#cb2-214" tabindex="-1"></a>main <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb2-215"><a href="#cb2-215" tabindex="-1"></a>  <span class="co"># Create a logged-in API session object once</span></span>
<span id="cb2-216"><a href="#cb2-216" tabindex="-1"></a>  session <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">&quot;https://bsky.social/xrpc/com.atproto.server.createSession&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-217"><a href="#cb2-217" tabindex="-1"></a>    <span class="fu">req_method</span>(<span class="st">&quot;POST&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-218"><a href="#cb2-218" tabindex="-1"></a>    <span class="fu">req_body_json</span>(<span class="fu">list</span>(</span>
<span id="cb2-219"><a href="#cb2-219" tabindex="-1"></a>      <span class="at">identifier =</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;BLUESKY_APP_USER&quot;</span>),</span>
<span id="cb2-220"><a href="#cb2-220" tabindex="-1"></a>      <span class="at">password =</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;BLUESKY_APP_PASS&quot;</span>)</span>
<span id="cb2-221"><a href="#cb2-221" tabindex="-1"></a>    )) <span class="sc">|&gt;</span></span>
<span id="cb2-222"><a href="#cb2-222" tabindex="-1"></a>    <span class="fu">req_perform</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-223"><a href="#cb2-223" tabindex="-1"></a>    <span class="fu">resp_body_json</span>()</span>
<span id="cb2-224"><a href="#cb2-224" tabindex="-1"></a>  </span>
<span id="cb2-225"><a href="#cb2-225" tabindex="-1"></a>  <span class="co"># Connect to the database</span></span>
<span id="cb2-226"><a href="#cb2-226" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), db_path)</span>
<span id="cb2-227"><a href="#cb2-227" tabindex="-1"></a>  </span>
<span id="cb2-228"><a href="#cb2-228" tabindex="-1"></a>  <span class="co"># Get the list of &#39;wwd-following&#39; handles</span></span>
<span id="cb2-229"><a href="#cb2-229" tabindex="-1"></a>  wwd_following_df <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb2-230"><a href="#cb2-230" tabindex="-1"></a>                                 <span class="st">&quot;SELECT * FROM follow_relationships WHERE tag = &#39;wwd-following&#39;&quot;</span>)</span>
<span id="cb2-231"><a href="#cb2-231" tabindex="-1"></a>  wwd_following_handles <span class="ot">&lt;-</span> <span class="fu">unique</span>(wwd_following_df<span class="sc">$</span>handle)</span>
<span id="cb2-232"><a href="#cb2-232" tabindex="-1"></a>  </span>
<span id="cb2-233"><a href="#cb2-233" tabindex="-1"></a>  <span class="co"># Disconnect from the database</span></span>
<span id="cb2-234"><a href="#cb2-234" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-235"><a href="#cb2-235" tabindex="-1"></a>  </span>
<span id="cb2-236"><a href="#cb2-236" tabindex="-1"></a>  <span class="co"># Fetch posts for the &#39;wwd-following&#39; handles, only new posts, writing to db as we fetch</span></span>
<span id="cb2-237"><a href="#cb2-237" tabindex="-1"></a>  <span class="fu">get_posts_from_handles</span>(wwd_following_handles, session, db_path)</span>
<span id="cb2-238"><a href="#cb2-238" tabindex="-1"></a>  </span>
<span id="cb2-239"><a href="#cb2-239" tabindex="-1"></a>  <span class="co"># Compute sentiment scores for new posts</span></span>
<span id="cb2-240"><a href="#cb2-240" tabindex="-1"></a>  <span class="fu">compute_sentiment_scores_for_new_posts</span>(db_path)</span>
<span id="cb2-241"><a href="#cb2-241" tabindex="-1"></a>  </span>
<span id="cb2-242"><a href="#cb2-242" tabindex="-1"></a>  <span class="co"># Connect to the database</span></span>
<span id="cb2-243"><a href="#cb2-243" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), db_path)</span>
<span id="cb2-244"><a href="#cb2-244" tabindex="-1"></a>  </span>
<span id="cb2-245"><a href="#cb2-245" tabindex="-1"></a>  <span class="co"># Build the list of handles for the SQL query</span></span>
<span id="cb2-246"><a href="#cb2-246" tabindex="-1"></a>  handle_list <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">sprintf</span>(<span class="st">&quot;&#39;%s&#39;&quot;</span>, wwd_following_handles), <span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb2-247"><a href="#cb2-247" tabindex="-1"></a>  </span>
<span id="cb2-248"><a href="#cb2-248" tabindex="-1"></a>  <span class="co"># Build the SQL query using sprintf</span></span>
<span id="cb2-249"><a href="#cb2-249" tabindex="-1"></a>  sql_query <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb2-250"><a href="#cb2-250" tabindex="-1"></a>    <span class="st">&quot;</span></span>
<span id="cb2-251"><a href="#cb2-251" tabindex="-1"></a><span class="st">    SELECT p.*, s.sentiment_score</span></span>
<span id="cb2-252"><a href="#cb2-252" tabindex="-1"></a><span class="st">    FROM posts p</span></span>
<span id="cb2-253"><a href="#cb2-253" tabindex="-1"></a><span class="st">    LEFT JOIN post_sentiment_scores s ON p.uri = s.uri</span></span>
<span id="cb2-254"><a href="#cb2-254" tabindex="-1"></a><span class="st">    WHERE p.author_handle IN (%s)</span></span>
<span id="cb2-255"><a href="#cb2-255" tabindex="-1"></a><span class="st">&quot;</span>,</span>
<span id="cb2-256"><a href="#cb2-256" tabindex="-1"></a>handle_list</span>
<span id="cb2-257"><a href="#cb2-257" tabindex="-1"></a>  )</span>
<span id="cb2-258"><a href="#cb2-258" tabindex="-1"></a>  </span>
<span id="cb2-259"><a href="#cb2-259" tabindex="-1"></a>  <span class="co"># Run the query</span></span>
<span id="cb2-260"><a href="#cb2-260" tabindex="-1"></a>  posts_with_sentiment <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, sql_query)</span>
<span id="cb2-261"><a href="#cb2-261" tabindex="-1"></a>  </span>
<span id="cb2-262"><a href="#cb2-262" tabindex="-1"></a>  <span class="co"># Disconnect from the database</span></span>
<span id="cb2-263"><a href="#cb2-263" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-264"><a href="#cb2-264" tabindex="-1"></a>  </span>
<span id="cb2-265"><a href="#cb2-265" tabindex="-1"></a>  <span class="co"># Compute average sentiment score per person</span></span>
<span id="cb2-266"><a href="#cb2-266" tabindex="-1"></a>  average_sentiment_per_person <span class="ot">&lt;-</span> posts_with_sentiment <span class="sc">%&gt;%</span></span>
<span id="cb2-267"><a href="#cb2-267" tabindex="-1"></a>    <span class="fu">group_by</span>(author_handle) <span class="sc">%&gt;%</span></span>
<span id="cb2-268"><a href="#cb2-268" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">average_sentiment =</span> <span class="fu">mean</span>(sentiment_score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-269"><a href="#cb2-269" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>)</span>
<span id="cb2-270"><a href="#cb2-270" tabindex="-1"></a>  </span>
<span id="cb2-271"><a href="#cb2-271" tabindex="-1"></a>  <span class="co"># View the results</span></span>
<span id="cb2-272"><a href="#cb2-272" tabindex="-1"></a>  <span class="fu">print</span>(average_sentiment_per_person)</span>
<span id="cb2-273"><a href="#cb2-273" tabindex="-1"></a>  </span>
<span id="cb2-274"><a href="#cb2-274" tabindex="-1"></a>  <span class="co"># Optionally, save the results to the database</span></span>
<span id="cb2-275"><a href="#cb2-275" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), db_path)</span>
<span id="cb2-276"><a href="#cb2-276" tabindex="-1"></a>  <span class="fu">dbWriteTable</span>(</span>
<span id="cb2-277"><a href="#cb2-277" tabindex="-1"></a>    con,</span>
<span id="cb2-278"><a href="#cb2-278" tabindex="-1"></a>    <span class="st">&quot;wwd_following_average_sentiment&quot;</span>,</span>
<span id="cb2-279"><a href="#cb2-279" tabindex="-1"></a>    average_sentiment_per_person,</span>
<span id="cb2-280"><a href="#cb2-280" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb2-281"><a href="#cb2-281" tabindex="-1"></a>  )</span>
<span id="cb2-282"><a href="#cb2-282" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-283"><a href="#cb2-283" tabindex="-1"></a>  </span>
<span id="cb2-284"><a href="#cb2-284" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Average sentiment scores computed and stored.&quot;</span>)</span>
<span id="cb2-285"><a href="#cb2-285" tabindex="-1"></a>}</span>
<span id="cb2-286"><a href="#cb2-286" tabindex="-1"></a></span>
<span id="cb2-287"><a href="#cb2-287" tabindex="-1"></a><span class="co"># Run the main function</span></span>
<span id="cb2-288"><a href="#cb2-288" tabindex="-1"></a><span class="fu">main</span>()</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Define the database path</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>db_path <span class="ot">&lt;-</span> <span class="st">&quot;C:/Users/steph/OneDrive/warp_and_weft_data/content/blog/bsky_sentiment_index/bluesky_data.duckdb&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"># Function to unfollow users based on criteria, excluding those who are following you</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>unfollow_users_based_on_criteria <span class="ot">&lt;-</span> <span class="cf">function</span>(db_path) {</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="co"># Create a logged-in API session object</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  session <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">&quot;https://bsky.social/xrpc/com.atproto.server.createSession&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>    <span class="fu">req_method</span>(<span class="st">&quot;POST&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>    <span class="fu">req_body_json</span>(<span class="fu">list</span>(</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>      <span class="at">identifier =</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;BLUESKY_APP_USER&quot;</span>),</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>      <span class="at">password =</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;BLUESKY_APP_PASS&quot;</span>)</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>    <span class="fu">req_perform</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>    <span class="fu">resp_body_json</span>()</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>  </span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>  <span class="co"># Get your own DID (Decentralized Identifier)</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>  self_did <span class="ot">&lt;-</span> session<span class="sc">$</span>did</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>  </span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>  <span class="co"># Connect to the database</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), db_path)</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>  </span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>  <span class="co"># Retrieve users with 0 posts</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>  users_with_zero_posts <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>    con,</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>    <span class="st">&quot;</span></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="st">    SELECT handle</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="st">    FROM follow_relationships</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a><span class="st">    WHERE tag = &#39;wwd-following&#39;</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a><span class="st">    AND handle NOT IN (SELECT DISTINCT author_handle FROM posts)</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a><span class="st">  &quot;</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>  )</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>  </span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>  <span class="co"># Retrieve users with average sentiment score below -5</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>  users_with_low_sentiment <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>    con,</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>    <span class="st">&quot;</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a><span class="st">    SELECT author_handle AS handle</span></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a><span class="st">    FROM wwd_following_average_sentiment</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a><span class="st">    WHERE average_sentiment &lt; 5</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a><span class="st">  &quot;</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>  )</span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>  </span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>  <span class="co"># Combine the users to unfollow</span></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>  users_to_unfollow <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(</span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>    users_with_zero_posts<span class="sc">$</span>handle,</span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>    users_with_low_sentiment<span class="sc">$</span>handle</span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>  ))</span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>  </span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a>  <span class="co"># Retrieve the list of users who are following you</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Fetching your followers...&quot;</span>)</span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a>  <span class="co"># Function to get all followers</span></span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a>  get_all_followers <span class="ot">&lt;-</span> <span class="cf">function</span>(session, user_did) {</span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a>    all_followers <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a>    cursor <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a>    </span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>      req <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">&quot;https://bsky.social/xrpc/app.bsky.graph.getFollowers&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>        <span class="fu">req_method</span>(<span class="st">&quot;GET&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a>        <span class="fu">req_headers</span>(<span class="at">Authorization =</span> <span class="fu">paste0</span>(<span class="st">&quot;Bearer &quot;</span>, session<span class="sc">$</span>accessJwt)) <span class="sc">%&gt;%</span></span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a>        <span class="fu">req_url_query</span>(<span class="at">actor =</span> user_did)</span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a>      </span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cursor)) {</span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a>        req <span class="ot">&lt;-</span> req <span class="sc">%&gt;%</span> <span class="fu">req_url_query</span>(<span class="at">cursor =</span> cursor)</span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a>      }</span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a>      </span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a>      resp <span class="ot">&lt;-</span> req <span class="sc">%&gt;%</span></span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a>        <span class="fu">req_error</span>(</span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a>          <span class="at">is_error =</span> <span class="cf">function</span>(resp)</span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a>            <span class="cn">FALSE</span></span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a>        <span class="fu">req_perform</span>()</span>
<span id="cb3-72"><a href="#cb3-72" tabindex="-1"></a>      </span>
<span id="cb3-73"><a href="#cb3-73" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">resp_status</span>(resp) <span class="sc">&gt;=</span> <span class="dv">400</span>) {</span>
<span id="cb3-74"><a href="#cb3-74" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;An error occurred fetching followers: &quot;</span>,</span>
<span id="cb3-75"><a href="#cb3-75" tabindex="-1"></a>                <span class="fu">resp_status_desc</span>(resp))</span>
<span id="cb3-76"><a href="#cb3-76" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">resp_body_string</span>(resp))</span>
<span id="cb3-77"><a href="#cb3-77" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-78"><a href="#cb3-78" tabindex="-1"></a>      }</span>
<span id="cb3-79"><a href="#cb3-79" tabindex="-1"></a>      </span>
<span id="cb3-80"><a href="#cb3-80" tabindex="-1"></a>      data <span class="ot">&lt;-</span> <span class="fu">resp_body_json</span>(resp)</span>
<span id="cb3-81"><a href="#cb3-81" tabindex="-1"></a>      </span>
<span id="cb3-82"><a href="#cb3-82" tabindex="-1"></a>      followers <span class="ot">&lt;-</span> data<span class="sc">$</span>followers</span>
<span id="cb3-83"><a href="#cb3-83" tabindex="-1"></a>      </span>
<span id="cb3-84"><a href="#cb3-84" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(followers) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-85"><a href="#cb3-85" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-86"><a href="#cb3-86" tabindex="-1"></a>      }</span>
<span id="cb3-87"><a href="#cb3-87" tabindex="-1"></a>      </span>
<span id="cb3-88"><a href="#cb3-88" tabindex="-1"></a>      all_followers <span class="ot">&lt;-</span> <span class="fu">c</span>(all_followers, followers)</span>
<span id="cb3-89"><a href="#cb3-89" tabindex="-1"></a>      </span>
<span id="cb3-90"><a href="#cb3-90" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(data<span class="sc">$</span>cursor)) {</span>
<span id="cb3-91"><a href="#cb3-91" tabindex="-1"></a>        cursor <span class="ot">&lt;-</span> data<span class="sc">$</span>cursor</span>
<span id="cb3-92"><a href="#cb3-92" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb3-93"><a href="#cb3-93" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-94"><a href="#cb3-94" tabindex="-1"></a>      }</span>
<span id="cb3-95"><a href="#cb3-95" tabindex="-1"></a>      </span>
<span id="cb3-96"><a href="#cb3-96" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="fl">0.1</span>) <span class="co"># Pause to respect rate limits</span></span>
<span id="cb3-97"><a href="#cb3-97" tabindex="-1"></a>    }</span>
<span id="cb3-98"><a href="#cb3-98" tabindex="-1"></a>    </span>
<span id="cb3-99"><a href="#cb3-99" tabindex="-1"></a>    <span class="co"># Process the followers into a tibble</span></span>
<span id="cb3-100"><a href="#cb3-100" tabindex="-1"></a>    followers_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(all_followers, <span class="cf">function</span>(user) {</span>
<span id="cb3-101"><a href="#cb3-101" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb3-102"><a href="#cb3-102" tabindex="-1"></a>        <span class="at">did =</span> user<span class="sc">$</span>did,</span>
<span id="cb3-103"><a href="#cb3-103" tabindex="-1"></a>        <span class="at">handle =</span> user<span class="sc">$</span>handle,</span>
<span id="cb3-104"><a href="#cb3-104" tabindex="-1"></a>        <span class="at">displayName =</span> user<span class="sc">$</span>displayName <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb3-105"><a href="#cb3-105" tabindex="-1"></a>        <span class="at">description =</span> user<span class="sc">$</span>description <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb3-106"><a href="#cb3-106" tabindex="-1"></a>        <span class="at">createdAt =</span> user<span class="sc">$</span>createdAt <span class="sc">%||%</span> <span class="cn">NA_character_</span></span>
<span id="cb3-107"><a href="#cb3-107" tabindex="-1"></a>      )</span>
<span id="cb3-108"><a href="#cb3-108" tabindex="-1"></a>    })</span>
<span id="cb3-109"><a href="#cb3-109" tabindex="-1"></a>    </span>
<span id="cb3-110"><a href="#cb3-110" tabindex="-1"></a>    <span class="fu">return</span>(followers_df)</span>
<span id="cb3-111"><a href="#cb3-111" tabindex="-1"></a>  }</span>
<span id="cb3-112"><a href="#cb3-112" tabindex="-1"></a>  </span>
<span id="cb3-113"><a href="#cb3-113" tabindex="-1"></a>  <span class="co"># Get your followers</span></span>
<span id="cb3-114"><a href="#cb3-114" tabindex="-1"></a>  followers_df <span class="ot">&lt;-</span> <span class="fu">get_all_followers</span>(session, self_did)</span>
<span id="cb3-115"><a href="#cb3-115" tabindex="-1"></a>  </span>
<span id="cb3-116"><a href="#cb3-116" tabindex="-1"></a>  <span class="co"># Exclude users who are following you from users_to_unfollow</span></span>
<span id="cb3-117"><a href="#cb3-117" tabindex="-1"></a>  followers_handles <span class="ot">&lt;-</span> followers_df<span class="sc">$</span>handle</span>
<span id="cb3-118"><a href="#cb3-118" tabindex="-1"></a>  users_to_unfollow <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(users_to_unfollow, followers_handles)</span>
<span id="cb3-119"><a href="#cb3-119" tabindex="-1"></a>  </span>
<span id="cb3-120"><a href="#cb3-120" tabindex="-1"></a>  <span class="co"># If there are no users to unfollow after exclusion, exit the function</span></span>
<span id="cb3-121"><a href="#cb3-121" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(users_to_unfollow) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-122"><a href="#cb3-122" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;No users meet the criteria for unfollowing after excluding followers.&quot;</span>)</span>
<span id="cb3-123"><a href="#cb3-123" tabindex="-1"></a>    <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-124"><a href="#cb3-124" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb3-125"><a href="#cb3-125" tabindex="-1"></a>  }</span>
<span id="cb3-126"><a href="#cb3-126" tabindex="-1"></a>  </span>
<span id="cb3-127"><a href="#cb3-127" tabindex="-1"></a>  <span class="co"># Fetch your follow records to get the rkey (record key)</span></span>
<span id="cb3-128"><a href="#cb3-128" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Fetching your follow records...&quot;</span>)</span>
<span id="cb3-129"><a href="#cb3-129" tabindex="-1"></a>  </span>
<span id="cb3-130"><a href="#cb3-130" tabindex="-1"></a>  get_follow_records <span class="ot">&lt;-</span> <span class="cf">function</span>(session, repo_did) {</span>
<span id="cb3-131"><a href="#cb3-131" tabindex="-1"></a>    all_records <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-132"><a href="#cb3-132" tabindex="-1"></a>    cursor <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-133"><a href="#cb3-133" tabindex="-1"></a>    </span>
<span id="cb3-134"><a href="#cb3-134" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb3-135"><a href="#cb3-135" tabindex="-1"></a>      req <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">&quot;https://bsky.social/xrpc/com.atproto.repo.listRecords&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-136"><a href="#cb3-136" tabindex="-1"></a>        <span class="fu">req_method</span>(<span class="st">&quot;GET&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-137"><a href="#cb3-137" tabindex="-1"></a>        <span class="fu">req_headers</span>(<span class="at">Authorization =</span> <span class="fu">paste0</span>(<span class="st">&quot;Bearer &quot;</span>, session<span class="sc">$</span>accessJwt)) <span class="sc">%&gt;%</span></span>
<span id="cb3-138"><a href="#cb3-138" tabindex="-1"></a>        <span class="fu">req_url_query</span>(<span class="at">repo =</span> repo_did,</span>
<span id="cb3-139"><a href="#cb3-139" tabindex="-1"></a>                      <span class="at">collection =</span> <span class="st">&quot;app.bsky.graph.follow&quot;</span>,</span>
<span id="cb3-140"><a href="#cb3-140" tabindex="-1"></a>                      <span class="at">limit =</span> <span class="dv">100</span>)</span>
<span id="cb3-141"><a href="#cb3-141" tabindex="-1"></a>      </span>
<span id="cb3-142"><a href="#cb3-142" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cursor)) {</span>
<span id="cb3-143"><a href="#cb3-143" tabindex="-1"></a>        req <span class="ot">&lt;-</span> req <span class="sc">%&gt;%</span> <span class="fu">req_url_query</span>(<span class="at">cursor =</span> cursor)</span>
<span id="cb3-144"><a href="#cb3-144" tabindex="-1"></a>      }</span>
<span id="cb3-145"><a href="#cb3-145" tabindex="-1"></a>      </span>
<span id="cb3-146"><a href="#cb3-146" tabindex="-1"></a>      resp <span class="ot">&lt;-</span> req <span class="sc">%&gt;%</span></span>
<span id="cb3-147"><a href="#cb3-147" tabindex="-1"></a>        <span class="fu">req_error</span>(</span>
<span id="cb3-148"><a href="#cb3-148" tabindex="-1"></a>          <span class="at">is_error =</span> <span class="cf">function</span>(resp)</span>
<span id="cb3-149"><a href="#cb3-149" tabindex="-1"></a>            <span class="cn">FALSE</span></span>
<span id="cb3-150"><a href="#cb3-150" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb3-151"><a href="#cb3-151" tabindex="-1"></a>        <span class="fu">req_perform</span>()</span>
<span id="cb3-152"><a href="#cb3-152" tabindex="-1"></a>      </span>
<span id="cb3-153"><a href="#cb3-153" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">resp_status</span>(resp) <span class="sc">&gt;=</span> <span class="dv">400</span>) {</span>
<span id="cb3-154"><a href="#cb3-154" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;An error occurred fetching follow records: &quot;</span>,</span>
<span id="cb3-155"><a href="#cb3-155" tabindex="-1"></a>                <span class="fu">resp_status_desc</span>(resp))</span>
<span id="cb3-156"><a href="#cb3-156" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">resp_body_string</span>(resp))</span>
<span id="cb3-157"><a href="#cb3-157" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-158"><a href="#cb3-158" tabindex="-1"></a>      }</span>
<span id="cb3-159"><a href="#cb3-159" tabindex="-1"></a>      </span>
<span id="cb3-160"><a href="#cb3-160" tabindex="-1"></a>      data <span class="ot">&lt;-</span> <span class="fu">resp_body_json</span>(resp)</span>
<span id="cb3-161"><a href="#cb3-161" tabindex="-1"></a>      </span>
<span id="cb3-162"><a href="#cb3-162" tabindex="-1"></a>      records <span class="ot">&lt;-</span> data<span class="sc">$</span>records</span>
<span id="cb3-163"><a href="#cb3-163" tabindex="-1"></a>      </span>
<span id="cb3-164"><a href="#cb3-164" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(records) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-165"><a href="#cb3-165" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-166"><a href="#cb3-166" tabindex="-1"></a>      }</span>
<span id="cb3-167"><a href="#cb3-167" tabindex="-1"></a>      </span>
<span id="cb3-168"><a href="#cb3-168" tabindex="-1"></a>      all_records <span class="ot">&lt;-</span> <span class="fu">c</span>(all_records, records)</span>
<span id="cb3-169"><a href="#cb3-169" tabindex="-1"></a>      </span>
<span id="cb3-170"><a href="#cb3-170" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(data<span class="sc">$</span>cursor)) {</span>
<span id="cb3-171"><a href="#cb3-171" tabindex="-1"></a>        cursor <span class="ot">&lt;-</span> data<span class="sc">$</span>cursor</span>
<span id="cb3-172"><a href="#cb3-172" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb3-173"><a href="#cb3-173" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-174"><a href="#cb3-174" tabindex="-1"></a>      }</span>
<span id="cb3-175"><a href="#cb3-175" tabindex="-1"></a>      </span>
<span id="cb3-176"><a href="#cb3-176" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="fl">0.1</span>) <span class="co"># Pause to respect rate limits</span></span>
<span id="cb3-177"><a href="#cb3-177" tabindex="-1"></a>    }</span>
<span id="cb3-178"><a href="#cb3-178" tabindex="-1"></a>    </span>
<span id="cb3-179"><a href="#cb3-179" tabindex="-1"></a>    <span class="co"># Process the records into a tibble</span></span>
<span id="cb3-180"><a href="#cb3-180" tabindex="-1"></a>    records_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(all_records, <span class="cf">function</span>(record) {</span>
<span id="cb3-181"><a href="#cb3-181" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb3-182"><a href="#cb3-182" tabindex="-1"></a>        <span class="at">uri =</span> record<span class="sc">$</span>uri,</span>
<span id="cb3-183"><a href="#cb3-183" tabindex="-1"></a>        <span class="at">rkey =</span> record<span class="sc">$</span>uri <span class="sc">%&gt;%</span> <span class="fu">basename</span>(),</span>
<span id="cb3-184"><a href="#cb3-184" tabindex="-1"></a>        <span class="at">cid =</span> record<span class="sc">$</span>cid,</span>
<span id="cb3-185"><a href="#cb3-185" tabindex="-1"></a>        <span class="at">createdAt =</span> record<span class="sc">$</span>value<span class="sc">$</span>createdAt <span class="sc">%||%</span> <span class="cn">NA_character_</span>,</span>
<span id="cb3-186"><a href="#cb3-186" tabindex="-1"></a>        <span class="at">subject_did =</span> record<span class="sc">$</span>value<span class="sc">$</span>subject <span class="sc">%||%</span> <span class="cn">NA_character_</span></span>
<span id="cb3-187"><a href="#cb3-187" tabindex="-1"></a>      )</span>
<span id="cb3-188"><a href="#cb3-188" tabindex="-1"></a>    })</span>
<span id="cb3-189"><a href="#cb3-189" tabindex="-1"></a>    </span>
<span id="cb3-190"><a href="#cb3-190" tabindex="-1"></a>    <span class="fu">return</span>(records_df)</span>
<span id="cb3-191"><a href="#cb3-191" tabindex="-1"></a>  }</span>
<span id="cb3-192"><a href="#cb3-192" tabindex="-1"></a>  </span>
<span id="cb3-193"><a href="#cb3-193" tabindex="-1"></a>  <span class="co"># Get your follow records</span></span>
<span id="cb3-194"><a href="#cb3-194" tabindex="-1"></a>  follow_records_df <span class="ot">&lt;-</span> <span class="fu">get_follow_records</span>(session, self_did)</span>
<span id="cb3-195"><a href="#cb3-195" tabindex="-1"></a>  </span>
<span id="cb3-196"><a href="#cb3-196" tabindex="-1"></a>  <span class="co"># Get the mapping of DIDs to handles from the database</span></span>
<span id="cb3-197"><a href="#cb3-197" tabindex="-1"></a>  did_handle_map <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb3-198"><a href="#cb3-198" tabindex="-1"></a>    con,</span>
<span id="cb3-199"><a href="#cb3-199" tabindex="-1"></a>    <span class="st">&quot;</span></span>
<span id="cb3-200"><a href="#cb3-200" tabindex="-1"></a><span class="st">    SELECT did, handle</span></span>
<span id="cb3-201"><a href="#cb3-201" tabindex="-1"></a><span class="st">    FROM follow_relationships</span></span>
<span id="cb3-202"><a href="#cb3-202" tabindex="-1"></a><span class="st">    WHERE did IS NOT NULL AND handle IS NOT NULL</span></span>
<span id="cb3-203"><a href="#cb3-203" tabindex="-1"></a><span class="st">  &quot;</span></span>
<span id="cb3-204"><a href="#cb3-204" tabindex="-1"></a>  )</span>
<span id="cb3-205"><a href="#cb3-205" tabindex="-1"></a>  </span>
<span id="cb3-206"><a href="#cb3-206" tabindex="-1"></a>  <span class="co"># Merge handles into follow_records_df</span></span>
<span id="cb3-207"><a href="#cb3-207" tabindex="-1"></a>  follow_records_df <span class="ot">&lt;-</span> follow_records_df <span class="sc">%&gt;%</span></span>
<span id="cb3-208"><a href="#cb3-208" tabindex="-1"></a>    <span class="fu">left_join</span>(did_handle_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;subject_did&quot;</span> <span class="ot">=</span> <span class="st">&quot;did&quot;</span>))</span>
<span id="cb3-209"><a href="#cb3-209" tabindex="-1"></a>  </span>
<span id="cb3-210"><a href="#cb3-210" tabindex="-1"></a>  <span class="co"># For any DIDs not found in the database, optionally resolve them via API (if necessary)</span></span>
<span id="cb3-211"><a href="#cb3-211" tabindex="-1"></a>  missing_handles <span class="ot">&lt;-</span> follow_records_df <span class="sc">%&gt;%</span></span>
<span id="cb3-212"><a href="#cb3-212" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">is.na</span>(handle)) <span class="sc">%&gt;%</span></span>
<span id="cb3-213"><a href="#cb3-213" tabindex="-1"></a>    <span class="fu">distinct</span>(subject_did)</span>
<span id="cb3-214"><a href="#cb3-214" tabindex="-1"></a>  </span>
<span id="cb3-215"><a href="#cb3-215" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(missing_handles) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-216"><a href="#cb3-216" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Resolving missing DIDs to handles via API...&quot;</span>)</span>
<span id="cb3-217"><a href="#cb3-217" tabindex="-1"></a>    resolve_dids_to_handles <span class="ot">&lt;-</span> <span class="cf">function</span>(dids) {</span>
<span id="cb3-218"><a href="#cb3-218" tabindex="-1"></a>      handles <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb3-219"><a href="#cb3-219" tabindex="-1"></a>      <span class="cf">for</span> (did <span class="cf">in</span> dids) {</span>
<span id="cb3-220"><a href="#cb3-220" tabindex="-1"></a>        req <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">&quot;https://bsky.social/xrpc/com.atproto.identity.resolveHandle&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-221"><a href="#cb3-221" tabindex="-1"></a>          <span class="fu">req_method</span>(<span class="st">&quot;GET&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-222"><a href="#cb3-222" tabindex="-1"></a>          <span class="fu">req_url_query</span>(<span class="at">did =</span> did)</span>
<span id="cb3-223"><a href="#cb3-223" tabindex="-1"></a>        </span>
<span id="cb3-224"><a href="#cb3-224" tabindex="-1"></a>        resp <span class="ot">&lt;-</span> req <span class="sc">%&gt;%</span></span>
<span id="cb3-225"><a href="#cb3-225" tabindex="-1"></a>          <span class="fu">req_error</span>(</span>
<span id="cb3-226"><a href="#cb3-226" tabindex="-1"></a>            <span class="at">is_error =</span> <span class="cf">function</span>(resp)</span>
<span id="cb3-227"><a href="#cb3-227" tabindex="-1"></a>              <span class="cn">FALSE</span></span>
<span id="cb3-228"><a href="#cb3-228" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb3-229"><a href="#cb3-229" tabindex="-1"></a>          <span class="fu">req_perform</span>()</span>
<span id="cb3-230"><a href="#cb3-230" tabindex="-1"></a>        </span>
<span id="cb3-231"><a href="#cb3-231" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">resp_status</span>(resp) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb3-232"><a href="#cb3-232" tabindex="-1"></a>          data <span class="ot">&lt;-</span> <span class="fu">resp_body_json</span>(resp)</span>
<span id="cb3-233"><a href="#cb3-233" tabindex="-1"></a>          handles <span class="ot">&lt;-</span> <span class="fu">c</span>(handles, data<span class="sc">$</span>handle)</span>
<span id="cb3-234"><a href="#cb3-234" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb3-235"><a href="#cb3-235" tabindex="-1"></a>          handles <span class="ot">&lt;-</span> <span class="fu">c</span>(handles, <span class="cn">NA_character_</span>)</span>
<span id="cb3-236"><a href="#cb3-236" tabindex="-1"></a>        }</span>
<span id="cb3-237"><a href="#cb3-237" tabindex="-1"></a>        <span class="fu">Sys.sleep</span>(<span class="fl">0.1</span>)</span>
<span id="cb3-238"><a href="#cb3-238" tabindex="-1"></a>      }</span>
<span id="cb3-239"><a href="#cb3-239" tabindex="-1"></a>      <span class="fu">return</span>(handles)</span>
<span id="cb3-240"><a href="#cb3-240" tabindex="-1"></a>    }</span>
<span id="cb3-241"><a href="#cb3-241" tabindex="-1"></a>    </span>
<span id="cb3-242"><a href="#cb3-242" tabindex="-1"></a>    <span class="co"># Resolve missing DIDs</span></span>
<span id="cb3-243"><a href="#cb3-243" tabindex="-1"></a>    resolved_handles <span class="ot">&lt;-</span> <span class="fu">resolve_dids_to_handles</span>(missing_handles<span class="sc">$</span>subject_did)</span>
<span id="cb3-244"><a href="#cb3-244" tabindex="-1"></a>    resolved_map <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">subject_did =</span> missing_handles<span class="sc">$</span>subject_did, <span class="at">handle =</span> resolved_handles)</span>
<span id="cb3-245"><a href="#cb3-245" tabindex="-1"></a>    </span>
<span id="cb3-246"><a href="#cb3-246" tabindex="-1"></a>    <span class="co"># Update follow_records_df with resolved handles</span></span>
<span id="cb3-247"><a href="#cb3-247" tabindex="-1"></a>    follow_records_df <span class="ot">&lt;-</span> follow_records_df <span class="sc">%&gt;%</span></span>
<span id="cb3-248"><a href="#cb3-248" tabindex="-1"></a>      <span class="fu">left_join</span>(resolved_map,</span>
<span id="cb3-249"><a href="#cb3-249" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;subject_did&quot;</span>,</span>
<span id="cb3-250"><a href="#cb3-250" tabindex="-1"></a>                <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;.resolved&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-251"><a href="#cb3-251" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">handle =</span> <span class="fu">coalesce</span>(handle, handle.resolved)) <span class="sc">%&gt;%</span></span>
<span id="cb3-252"><a href="#cb3-252" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>handle.resolved)</span>
<span id="cb3-253"><a href="#cb3-253" tabindex="-1"></a>  }</span>
<span id="cb3-254"><a href="#cb3-254" tabindex="-1"></a>  </span>
<span id="cb3-255"><a href="#cb3-255" tabindex="-1"></a>  <span class="co"># Find the records corresponding to users_to_unfollow</span></span>
<span id="cb3-256"><a href="#cb3-256" tabindex="-1"></a>  records_to_delete <span class="ot">&lt;-</span> follow_records_df <span class="sc">%&gt;%</span></span>
<span id="cb3-257"><a href="#cb3-257" tabindex="-1"></a>    <span class="fu">filter</span>(handle <span class="sc">%in%</span> users_to_unfollow)</span>
<span id="cb3-258"><a href="#cb3-258" tabindex="-1"></a>  </span>
<span id="cb3-259"><a href="#cb3-259" tabindex="-1"></a>  <span class="co"># If there are no matching records, exit the function</span></span>
<span id="cb3-260"><a href="#cb3-260" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(records_to_delete) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-261"><a href="#cb3-261" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;No matching follow records found to unfollow.&quot;</span>)</span>
<span id="cb3-262"><a href="#cb3-262" tabindex="-1"></a>    <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-263"><a href="#cb3-263" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb3-264"><a href="#cb3-264" tabindex="-1"></a>  }</span>
<span id="cb3-265"><a href="#cb3-265" tabindex="-1"></a>  </span>
<span id="cb3-266"><a href="#cb3-266" tabindex="-1"></a>  <span class="co"># Function to unfollow a user by deleting the follow record</span></span>
<span id="cb3-267"><a href="#cb3-267" tabindex="-1"></a>  unfollow_user <span class="ot">&lt;-</span> <span class="cf">function</span>(session, repo_did, rkey) {</span>
<span id="cb3-268"><a href="#cb3-268" tabindex="-1"></a>    req <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">&quot;https://bsky.social/xrpc/com.atproto.repo.deleteRecord&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-269"><a href="#cb3-269" tabindex="-1"></a>      <span class="fu">req_method</span>(<span class="st">&quot;POST&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-270"><a href="#cb3-270" tabindex="-1"></a>      <span class="fu">req_headers</span>(<span class="at">Authorization =</span> <span class="fu">paste0</span>(<span class="st">&quot;Bearer &quot;</span>, session<span class="sc">$</span>accessJwt)) <span class="sc">%&gt;%</span></span>
<span id="cb3-271"><a href="#cb3-271" tabindex="-1"></a>      <span class="fu">req_body_json</span>(<span class="fu">list</span>(</span>
<span id="cb3-272"><a href="#cb3-272" tabindex="-1"></a>        <span class="at">collection =</span> <span class="st">&quot;app.bsky.graph.follow&quot;</span>,</span>
<span id="cb3-273"><a href="#cb3-273" tabindex="-1"></a>        <span class="at">repo =</span> repo_did,</span>
<span id="cb3-274"><a href="#cb3-274" tabindex="-1"></a>        <span class="at">rkey =</span> rkey</span>
<span id="cb3-275"><a href="#cb3-275" tabindex="-1"></a>      ))</span>
<span id="cb3-276"><a href="#cb3-276" tabindex="-1"></a>    </span>
<span id="cb3-277"><a href="#cb3-277" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> req <span class="sc">%&gt;%</span></span>
<span id="cb3-278"><a href="#cb3-278" tabindex="-1"></a>      <span class="fu">req_error</span>(</span>
<span id="cb3-279"><a href="#cb3-279" tabindex="-1"></a>        <span class="at">is_error =</span> <span class="cf">function</span>(resp)</span>
<span id="cb3-280"><a href="#cb3-280" tabindex="-1"></a>          <span class="cn">FALSE</span></span>
<span id="cb3-281"><a href="#cb3-281" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb3-282"><a href="#cb3-282" tabindex="-1"></a>      <span class="fu">req_perform</span>()</span>
<span id="cb3-283"><a href="#cb3-283" tabindex="-1"></a>    </span>
<span id="cb3-284"><a href="#cb3-284" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">resp_status</span>(resp) <span class="sc">&gt;=</span> <span class="dv">400</span>) {</span>
<span id="cb3-285"><a href="#cb3-285" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;Failed to unfollow rkey &quot;</span>,</span>
<span id="cb3-286"><a href="#cb3-286" tabindex="-1"></a>              rkey,</span>
<span id="cb3-287"><a href="#cb3-287" tabindex="-1"></a>              <span class="st">&quot;: &quot;</span>,</span>
<span id="cb3-288"><a href="#cb3-288" tabindex="-1"></a>              <span class="fu">resp_status_desc</span>(resp))</span>
<span id="cb3-289"><a href="#cb3-289" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">resp_body_string</span>(resp))</span>
<span id="cb3-290"><a href="#cb3-290" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-291"><a href="#cb3-291" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;Successfully unfollowed rkey &quot;</span>, rkey)</span>
<span id="cb3-292"><a href="#cb3-292" tabindex="-1"></a>    }</span>
<span id="cb3-293"><a href="#cb3-293" tabindex="-1"></a>  }</span>
<span id="cb3-294"><a href="#cb3-294" tabindex="-1"></a>  </span>
<span id="cb3-295"><a href="#cb3-295" tabindex="-1"></a>  <span class="co"># Unfollow each user</span></span>
<span id="cb3-296"><a href="#cb3-296" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Unfollowing users who meet the criteria...&quot;</span>)</span>
<span id="cb3-297"><a href="#cb3-297" tabindex="-1"></a>  </span>
<span id="cb3-298"><a href="#cb3-298" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(records_to_delete))) {</span>
<span id="cb3-299"><a href="#cb3-299" tabindex="-1"></a>    rkey <span class="ot">&lt;-</span> records_to_delete<span class="sc">$</span>rkey[i]</span>
<span id="cb3-300"><a href="#cb3-300" tabindex="-1"></a>    handle <span class="ot">&lt;-</span> records_to_delete<span class="sc">$</span>handle[i]</span>
<span id="cb3-301"><a href="#cb3-301" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Unfollowing user: &quot;</span>, handle)</span>
<span id="cb3-302"><a href="#cb3-302" tabindex="-1"></a>    <span class="fu">unfollow_user</span>(session, self_did, rkey)</span>
<span id="cb3-303"><a href="#cb3-303" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="fl">0.1</span>) <span class="co"># Pause to respect rate limits</span></span>
<span id="cb3-304"><a href="#cb3-304" tabindex="-1"></a>  }</span>
<span id="cb3-305"><a href="#cb3-305" tabindex="-1"></a>  </span>
<span id="cb3-306"><a href="#cb3-306" tabindex="-1"></a>  <span class="co"># Disconnect from the database</span></span>
<span id="cb3-307"><a href="#cb3-307" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-308"><a href="#cb3-308" tabindex="-1"></a>  </span>
<span id="cb3-309"><a href="#cb3-309" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Unfollowing process completed.&quot;</span>)</span>
<span id="cb3-310"><a href="#cb3-310" tabindex="-1"></a>}</span>
<span id="cb3-311"><a href="#cb3-311" tabindex="-1"></a></span>
<span id="cb3-312"><a href="#cb3-312" tabindex="-1"></a><span class="co"># Run the function</span></span>
<span id="cb3-313"><a href="#cb3-313" tabindex="-1"></a><span class="fu">unfollow_users_based_on_criteria</span>(db_path)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Function to create a histogram of average sentiment scores of remaining follows</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>create_histogram_of_avg_sentiment <span class="ot">&lt;-</span> <span class="cf">function</span>(db_path) {</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="co"># Connect to the database</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), db_path)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  </span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="co"># Retrieve the list of users you are currently following</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  follows_df <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>                           <span class="st">&quot;SELECT * FROM follow_relationships WHERE tag = &#39;wwd-following&#39;&quot;</span>)</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  </span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>  <span class="co"># Retrieve the average sentiment scores</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>  avg_sentiment_df <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    con,</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="st">&quot;SELECT author_handle AS handle, average_sentiment FROM wwd_following_average_sentiment&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>  )</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>  </span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>  <span class="co"># Merge the data to get the average sentiment scores of your current follows</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  merged_df <span class="ot">&lt;-</span> follows_df <span class="sc">%&gt;%</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>    <span class="fu">inner_join</span>(avg_sentiment_df, <span class="at">by =</span> <span class="st">&quot;handle&quot;</span>)</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>  </span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>  <span class="co"># Disconnect from the database</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>  </span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>  <span class="co"># Check if there are any data to plot</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(merged_df) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;No data available to plot.&quot;</span>)</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>  }</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>  </span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>  <span class="co"># Plot the histogram</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>  <span class="fu">ggplot</span>(merged_df, <span class="fu">aes</span>(<span class="at">x =</span> average_sentiment)) <span class="sc">+</span></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(</span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>      <span class="at">binwidth =</span> <span class="dv">1</span>,</span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">&quot;steelblue&quot;</span>,</span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Histogram of Average Sentiment Scores of Remaining Follows&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Average Sentiment Score&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Number of Users&quot;</span>) <span class="sc">+</span></span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>}</span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a><span class="co"># Run the function to create the histogram</span></span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a><span class="fu">create_histogram_of_avg_sentiment</span>(db_path)</span></code></pre></div>

        
        <details closed class="f6 fw7 input-reset">
  <dl class="f6 lh-copy">
    <dt class="fw7">Posted on:</dt>
    <dd class="fw5 ml0">January 1, 0001</dd>
  </dl>
  <dl class="f6 lh-copy">
    <dt class="fw7">Length:</dt>
    <dd class="fw5 ml0">12 minute read, 2525 words</dd>
  </dl>
  
  
  
  <dl class="f6 lh-copy">
    <dt class="fw7">See Also:</dt>
    
  </dl>
</details>

      </section>
      <footer class="post-footer">
        <div class="post-pagination dt w-100 mt4 mb2">
  
  
    <a class="prev dtc pr2 tl v-top fw6"
    href="http://localhost:4321/blog/duckdb_intro/">&larr; Using DuckDB in R: A Walkthrough Starting with MySQL</a>
  
  
  
</div>

      </footer>
    </article>
    
      <div class="post-comments pa0 pa4-l mt4">
  
    
      <script src="https://utteranc.es/client.js"
              repo="stewing-co/warp_and_weft_data"
              issue-term="pathname"
              theme="boxy-light"
              label="comments :crystal_ball:"
              crossorigin="anonymous"
              async
              type="text/javascript">
      </script>
    
  
</div>

    
  </section>
</main>
<footer class="site-footer pv4 bt b--transparent ph5" role="contentinfo">
  <nav class="db dt-l w-100">
    <p class="site-copyright f7 db dtc-l v-mid w-100 w-33-l tc tl-l pv2 pv0-l mv0 lh-copy">
      &copy; 2024 Warp and Weft Data, Atlanta, GA
      <span class="middot-divider"></span>
      Made with <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/hugo-apero/" rel="dct:source">Hugo Apéro</a></span>.
      <br />
      
Based on <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/formspree/blogophonic-hugo" rel="dct:source">Blogophonic</a></span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://formspree.io" property="cc:attributionName" rel="cc:attributionURL">Formspree</a>.
    </p>
    
    <div class="site-social-links db dtc-l v-mid w-100 w-33-l tc pv2 pv0-l mv0">
      <div class="social-icon-links" aria-hidden="true">
  
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://github.com/stewing-co" title="github" target="_blank" rel="me noopener">
      <i class="fab fa-github fa-lg fa-fw"></i>
    </a>
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://bsky.app/profile/warpandweftdata.com" title="bluesky" target="_blank" rel="me noopener">
      <i class="fab fa-bluesky fa-lg fa-fw"></i>
    </a>
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://www.linkedin.com/in/stewing-in/" title="linkedin" target="_blank" rel="me noopener">
      <i class="fab fa-linkedin fa-lg fa-fw"></i>
    </a>
  
</div>

    </div>
    
    <div class="site-links f6 db dtc-l v-mid w-100 w-67-l tc tr-l pv2 pv0-l mv0">
      
      <a class="dib pv1 ph2 link" href="/license/" title="License">License</a>
      
      <a class="dib pv1 ph2 link" href="/contact/" title="Contact form">Contact</a>
      
    </div>
  </nav>
  
    <script>

    var i, text, code, codes = document.getElementsByTagName('code');
    for (let i = 0; i < codes.length;) {
      code = codes[i];
      if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
        text = code.textContent;
        if (/^\$[^$]/.test(text) && /[^$]\$$/.test(text)) {
          text = text.replace(/^\$/, '\\(').replace(/\$$/, '\\)');
          code.textContent = text;
        }
        if (/^\\\((.|\s)+\\\)$/.test(text) ||
            /^\\\[(.|\s)+\\\]$/.test(text) ||
            /^\$(.|\s)+\$$/.test(text) ||
            /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
          code.outerHTML = code.innerHTML;  
          continue;
        }
      }
      i++;
    }
</script>

  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>



    
  
  
</footer>

      </div>
    </body>
</html>
