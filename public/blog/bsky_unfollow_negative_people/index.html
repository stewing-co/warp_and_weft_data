<!DOCTYPE html>
<html lang="en" dir="ltr"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=4321&amp;path=livereload" data-no-instant defer></script>
  
                           
     


<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.136.2">
<title>Bluesky Unfollowing Negative Follows | Warp and Weft Data</title>


<meta property="twitter:site" content="@blue_pibble">
<meta property="twitter:creator" content="@blue_pibble">







  
    
  
<meta name="description" content="If you don&#39;t follow me and are negative you can take a hike">


<meta property="og:site_name" content="Warp and Weft Data">
<meta property="og:title" content="Bluesky Unfollowing Negative Follows | Warp and Weft Data">
<meta property="og:description" content="If you don&#39;t follow me and are negative you can take a hike" />
<meta property="og:type" content="page" />
<meta property="og:url" content="http://localhost:4321/blog/bsky_unfollow_negative_people/" />
<meta property="og:locale" content="en">




    
        <meta property="og:image" content="http://localhost:4321/blog/bsky_unfollow_negative_people/featured.jpg" >
        <meta property="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="http://localhost:4321/blog/bsky_unfollow_negative_people/featured.jpg" >
    
    
  
  <meta itemprop="name" content="Bluesky Unfollowing Negative Follows">
  <meta itemprop="description" content="I followed a ton of people using the new starter packs. Now I’m going to keep all my mutuals and unfollow the people I’m following who aren’t following me back and who have a net negative sentiment score on their posts.
# Load necessary libraries library(DBI) library(duckdb) library(tidyverse) ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──## ✔ dplyr 1.1.4 ✔ readr 2.1.5## ✔ forcats 1.0.0 ✔ stringr 1.5.1## ✔ ggplot2 3.5.1 ✔ tibble 3.2.1## ✔ lubridate 1.9.3 ✔ tidyr 1.3.1## ✔ purrr 1.0.2 ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──## ✖ dplyr::filter() masks stats::filter()## ✖ dplyr::lag() masks stats::lag()## ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors library(tidytext) library(httr2) library(parsedate) ## ## Attaching package: &#39;parsedate&#39;## ## The following object is masked from &#39;package:readr&#39;:## ## parse_date get_follow_relationships &lt;- function(db_path) { library(tidyverse) library(httr2) library(DBI) library(duckdb) # Create a logged-in API session object session &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.server.createSession&#34;) |&gt; req_method(&#34;POST&#34;) |&gt; req_body_json(list( identifier = Sys.getenv(&#34;BLUESKY_APP_USER&#34;), password = Sys.getenv(&#34;BLUESKY_APP_PASS&#34;) )) |&gt; req_perform() |&gt; resp_body_json() # Get your own DID (Decentralized Identifier) self_handle &lt;- session$handle self_did &lt;- session$did # Function to get all follows or followers get_all_follows &lt;- function(endpoint_url, user_did) { all_users &lt;- list() cursor &lt;- NULL repeat { req &lt;- request(endpoint_url) |&gt; req_method(&#34;GET&#34;) |&gt; req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) |&gt; req_url_query(actor = user_did) if (!is.null(cursor)) { req &lt;- req |&gt; req_url_query(cursor = cursor) } resp &lt;- req |&gt; req_error( is_error = function(resp) FALSE ) |&gt; req_perform() if (resp_status(resp) &gt;= 400) { message(&#34;An error occurred fetching data: &#34;, resp_status_desc(resp)) print(resp_body_string(resp)) break } data &lt;- resp_body_json(resp) # Determine if fetching followers or following if (&#34;followers&#34; %in% names(data)) { users &lt;- data$followers } else if (&#34;follows&#34; %in% names(data)) { users &lt;- data$follows } else { message(&#34;Unexpected data format.&#34;) break } # Check if users list is empty if (length(users) == 0) { break } all_users &lt;- c(all_users, users) if (!is.null(data$cursor)) { cursor &lt;- data$cursor } else { break } Sys.sleep(0.1) # Pause to respect rate limits } # Process the users into a tibble users_df &lt;- map_dfr(all_users, function(user) { tibble( did = user$did, handle = user$handle, displayName = user$displayName %||% NA_character_, description = user$description %||% NA_character_, createdAt = user$createdAt %||% NA_character_ ) }) return(users_df) } # Get followers message(&#34;Fetching your followers...&#34;) followers_df &lt;- get_all_follows(&#34;https://bsky.social/xrpc/app.bsky.graph.getFollowers&#34;, self_did) # Get following message(&#34;Fetching users you are following...&#34;) following_df &lt;- get_all_follows(&#34;https://bsky.social/xrpc/app.bsky.graph.getFollows&#34;, self_did) # Identify relationships followers_handles &lt;- followers_df$handle following_handles &lt;- following_df$handle # Users you are following who aren&#39;t following you back wwd_following &lt;- following_df %&gt;% filter(!handle %in% followers_handles) %&gt;% mutate(tag = &#34;wwd-following&#34;) # Users who are following you but you aren&#39;t following back wwd_follower &lt;- followers_df %&gt;% filter(!handle %in% following_handles) %&gt;% mutate(tag = &#34;wwd-follower&#34;) # Mutual follows wwd_mutuals &lt;- following_df %&gt;% filter(handle %in% followers_handles) %&gt;% mutate(tag = &#34;wwd-mutuals&#34;) # Combine all relationships_df &lt;- bind_rows(wwd_following, wwd_follower, wwd_mutuals) # Connect to the database con &lt;- dbConnect(duckdb::duckdb(), db_path) # Save relationships to the database dbWriteTable(con, &#34;follow_relationships&#34;, relationships_df, overwrite = TRUE) # Disconnect from the database dbDisconnect(con, shutdown = TRUE) message(&#34;Follow relationships have been stored in the database.&#34;) # Return the data frame return(relationships_df) } # Define the path to your database db_path &lt;- &#34;C:/Users/steph/OneDrive/warp_and_weft_data/content/blog/bsky_sentiment_index/bluesky_data.duckdb&#34; # Call the function with the database path relationships &lt;- get_follow_relationships(db_path) ## Fetching your followers...## Fetching users you are following...## Follow relationships have been stored in the database. # View the results print(relationships) ## # A tibble: 972 × 6## did handle displayName description createdAt tag ## &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;## 1 did:plc:qofqpqau42nmrqgtcqpr4… tooma… &#34;seven ex … &#34;humanoid … 2024-11-… wwd-…## 2 did:plc:4dlr3yhphrh6vc7q627mc… aklot… &#34;Alex Klot… &#34;Physics p… 2023-06-… wwd-…## 3 did:plc:yz7ogsukyb7j6mup6udg5… annag… &#34;Anna Hugh… &#34;\U0001f30… 2023-05-… wwd-…## 4 did:plc:uwscsrt6wq2pahbzef2nc… sanja… &#34;sanjana c… &#34;nuclear a… 2023-04-… wwd-…## 5 did:plc:spanui6736cbvrbrci2hx… astro… &#34;Brandon B… &#34;computati… 2023-06-… wwd-…## 6 did:plc:5ufuqy3qstws4yzjuixf4… frogs… &#34;anna !!! … &#34;| she/her… 2023-04-… wwd-…## 7 did:plc:gvcmzzacbgwgttvcxzytp… astro… &#34;athena, g… &#34;astrophys… 2023-08-… wwd-…## 8 did:plc:my5x3kz6owobc5mcncdo4… adeen… &#34;Dr. Adeen… &#34;Planetary… 2023-06-… wwd-…## 9 did:plc:2bppr6lzjxvpcrp5lho6j… focus… &#34;katie&#34; &#34;opinions … 2023-04-… wwd-…## 10 did:plc:qzmgfnhb76ffudt7utnmy… yonib… &#34;Yoni Bran… &#34;astrologe… 2023-05-… wwd-…## # ℹ 962 more rows # Function to get posts from a vector of handles, fetching only new posts and writing to db as it fetches get_posts_from_handles &lt;- function(handles, session, db_path) { # Connect to the database con &lt;- dbConnect(duckdb::duckdb(), db_path) # Loop over each handle for (handle in handles) { message(&#34;Fetching posts for handle: &#34;, handle) # Get the latest record_createdAt for this handle from the posts table latest_time_query &lt;- sprintf( &#34;SELECT MAX(record_createdAt) as latest_time FROM posts WHERE author_handle = &#39;%s&#39;&#34;, handle ) latest_time_result &lt;- dbGetQuery(con, latest_time_query) latest_time &lt;- latest_time_result$latest_time[1] # If there is no latest_time (i.e., no posts for this handle), set to NULL if (is.na(latest_time) || is.null(latest_time)) { latest_time &lt;- NULL message(&#34;No existing posts found for handle: &#34;, handle) } else { message(&#34;Latest post time for &#34;, handle, &#34;: &#34;, latest_time) } # Initialize variables for fetching posts # We will process and write posts as we fetch them cursor &lt;- NULL keep_fetching &lt;- TRUE repeat { # Construct the GET request req &lt;- request(&#34;https://bsky.social/xrpc/app.bsky.feed.getAuthorFeed&#34;) |&gt; req_method(&#34;GET&#34;) |&gt; req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) |&gt; req_url_query(actor = handle) # If cursor is not NULL, add it to the query if (!is.null(cursor)) { req &lt;- req |&gt; req_url_query(cursor = cursor) } # Perform the request resp &lt;- req |&gt; req_error( is_error = function(resp) FALSE ) |&gt; req_perform() # Check if the response is an error if (resp_status(resp) &gt;= 400) { message(&#34;An error occurred fetching posts for &#34;, handle, &#34;: &#34;, resp_status_desc(resp)) # Optionally, print the response body for more details print(resp_body_string(resp)) break } # Parse the response feed_data &lt;- resp_body_json(resp) # Check if feed is empty if (length(feed_data$feed) == 0) { message(&#34;No posts found for handle: &#34;, handle) break } # Process posts and check timestamps posts_to_add &lt;- list() for (post in feed_data$feed) { post_time &lt;- post$post$record$createdAt %||% &#34;&#34; if (post_time == &#34;&#34;) next # Skip if no timestamp # Parse the timestamps using parsedate::parse_iso_8601 post_time_parsed &lt;- parse_iso_8601(post_time) latest_time_parsed &lt;- if (!is.null(latest_time)) parse_iso_8601(latest_time) else NULL # Compare post_time with latest_time if (!is.null(latest_time_parsed) &amp;&amp; !is.na(post_time_parsed) &amp;&amp; post_time_parsed &lt;= latest_time_parsed) { # Reached posts we&#39;ve already fetched keep_fetching &lt;- FALSE break } else { # New post, add to the list posts_to_add &lt;- c(posts_to_add, list(post)) } } # If there are new posts to add, process and write them to the database if (length(posts_to_add) &gt; 0) { posts_df &lt;- map_dfr(posts_to_add, function(post) { tibble( uri = post$post$uri, cid = post$post$cid, author_did = post$post$author$did %||% NA_character_, author_handle = post$post$author$handle %||% NA_character_, author_displayName = post$post$author$displayName %||% NA_character_, record_type = post$post$record$`$type` %||% NA_character_, record_text = post$post$record$text %||% NA_character_, record_createdAt = post$post$record$createdAt %||% NA_character_, reply_root = post$post$record$reply$root$uri %||% NA_character_, reply_parent = post$post$record$reply$parent$uri %||% NA_character_, repost_count = post$post$repostCount %||% NA_integer_, reply_count = post$post$replyCount %||% NA_integer_, like_count = post$post$likeCount %||% NA_integer_, indexed_at = post$post$indexedAt %||% NA_character_ ) }) # Write the new posts to the &#39;posts&#39; table, appending dbWriteTable(con, &#34;posts&#34;, posts_df, append = TRUE) message(&#34;Wrote &#34;, nrow(posts_df), &#34; new posts for handle: &#34;, handle) } else { message(&#34;No new posts to add for handle: &#34;, handle) } # Break the loop if we&#39;ve reached existing posts if (!keep_fetching) { break } # Update cursor if (!is.null(feed_data$cursor)) { cursor &lt;- feed_data$cursor } else { # No more pages to fetch break } # Optional: Pause to respect rate limits Sys.sleep(0.1) } } # Disconnect from the database dbDisconnect(con, shutdown = FALSE) # Keep the database running for other operations } # Function to compute sentiment scores for new posts compute_sentiment_scores_for_new_posts &lt;- function(db_path) { # Connect to the database con &lt;- dbConnect(duckdb::duckdb(), db_path) # Get the list of uris of posts that already have sentiment scores existing_scores &lt;- dbGetQuery(con, &#34;SELECT uri FROM post_sentiment_scores&#34;) # Get the list of uris of all posts all_posts &lt;- dbGetQuery(con, &#34;SELECT uri, record_text FROM posts&#34;) # Filter posts that don&#39;t have sentiment scores yet posts_to_score &lt;- all_posts %&gt;% filter(!uri %in% existing_scores$uri) %&gt;% filter(!is.na(record_text)) # If there are no new posts to score, exit the function if (nrow(posts_to_score) == 0) { message(&#34;No new posts to compute sentiment scores for.&#34;) dbDisconnect(con, shutdown = FALSE) return(NULL) } # Tokenize the text posts_tokens &lt;- posts_to_score %&gt;% unnest_tokens(word, record_text) # Get the AFINN sentiment lexicon afinn &lt;- get_sentiments(&#34;afinn&#34;) # Join tokens with sentiment lexicon posts_sentiment &lt;- posts_tokens %&gt;% inner_join(afinn, by = &#34;word&#34;) # Compute sentiment score per post post_sentiment_scores &lt;- posts_sentiment %&gt;% group_by(uri) %&gt;% summarise(sentiment_score = sum(value), .groups = &#34;drop&#34;) # Handle posts without sentiment words all_uris &lt;- posts_to_score$uri post_sentiment_scores &lt;- tibble(uri = all_uris) %&gt;% left_join(post_sentiment_scores, by = &#34;uri&#34;) %&gt;% mutate(sentiment_score = replace_na(sentiment_score, 0)) # Write the new sentiment scores to the database, appending dbWriteTable(con, &#34;post_sentiment_scores&#34;, post_sentiment_scores, append = TRUE) # Disconnect from the database dbDisconnect(con, shutdown = FALSE) message(&#34;Sentiment scores computed for new posts.&#34;) } # Main script to get posts and compute average sentiment scores main &lt;- function() { # Create a logged-in API session object once session &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.server.createSession&#34;) |&gt; req_method(&#34;POST&#34;) |&gt; req_body_json(list( identifier = Sys.getenv(&#34;BLUESKY_APP_USER&#34;), password = Sys.getenv(&#34;BLUESKY_APP_PASS&#34;) )) |&gt; req_perform() |&gt; resp_body_json() # Connect to the database con &lt;- dbConnect(duckdb::duckdb(), db_path) # Get the list of &#39;wwd-following&#39; handles wwd_following_df &lt;- dbGetQuery(con, &#34;SELECT * FROM follow_relationships WHERE tag = &#39;wwd-following&#39;&#34;) wwd_following_handles &lt;- unique(wwd_following_df$handle) # Disconnect from the database dbDisconnect(con, shutdown = FALSE) # Fetch posts for the &#39;wwd-following&#39; handles, only new posts, writing to db as we fetch get_posts_from_handles(wwd_following_handles, session, db_path) # Compute sentiment scores for new posts compute_sentiment_scores_for_new_posts(db_path) # Connect to the database con &lt;- dbConnect(duckdb::duckdb(), db_path) # Build the list of handles for the SQL query handle_list &lt;- paste(sprintf(&#34;&#39;%s&#39;&#34;, wwd_following_handles), collapse = &#34;,&#34;) # Build the SQL query using sprintf sql_query &lt;- sprintf( &#34; SELECT p.*, s.sentiment_score FROM posts p LEFT JOIN post_sentiment_scores s ON p.uri = s.uri WHERE p.author_handle IN (%s) &#34;, handle_list ) # Run the query posts_with_sentiment &lt;- dbGetQuery(con, sql_query) # Disconnect from the database dbDisconnect(con, shutdown = FALSE) # Compute average sentiment score per person average_sentiment_per_person &lt;- posts_with_sentiment %&gt;% group_by(author_handle) %&gt;% summarise(average_sentiment = mean(sentiment_score, na.rm = TRUE), .groups = &#34;drop&#34;) # View the results print(average_sentiment_per_person) # Optionally, save the results to the database con &lt;- dbConnect(duckdb::duckdb(), db_path) dbWriteTable( con, &#34;wwd_following_average_sentiment&#34;, average_sentiment_per_person, overwrite = TRUE ) dbDisconnect(con, shutdown = TRUE) message(&#34;Average sentiment scores computed and stored.&#34;) } # Run the main function main() # Function to unfollow users based on criteria, excluding those who are following you unfollow_users_based_on_criteria &lt;- function(db_path) { # Create a logged-in API session object session &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.server.createSession&#34;) %&gt;% req_method(&#34;POST&#34;) %&gt;% req_body_json(list( identifier = Sys.getenv(&#34;BLUESKY_APP_USER&#34;), password = Sys.getenv(&#34;BLUESKY_APP_PASS&#34;) )) %&gt;% req_perform() %&gt;% resp_body_json() # Get your own DID (Decentralized Identifier) self_did &lt;- session$did # Connect to the database con &lt;- dbConnect(duckdb::duckdb(), db_path) # Retrieve users with 0 posts users_with_zero_posts &lt;- dbGetQuery( con, &#34; SELECT handle FROM follow_relationships WHERE tag = &#39;wwd-following&#39; AND handle NOT IN (SELECT DISTINCT author_handle FROM posts) &#34; ) # Retrieve users with average sentiment score below -5 users_with_low_sentiment &lt;- dbGetQuery( con, &#34; SELECT author_handle AS handle FROM wwd_following_average_sentiment WHERE average_sentiment &lt; 1 &#34; ) # Combine the users to unfollow users_to_unfollow &lt;- unique(c( users_with_zero_posts$handle, users_with_low_sentiment$handle )) # Retrieve the list of users who are following you message(&#34;Fetching your followers...&#34;) # Function to get all followers get_all_followers &lt;- function(session, user_did) { all_followers &lt;- list() cursor &lt;- NULL repeat { req &lt;- request(&#34;https://bsky.social/xrpc/app.bsky.graph.getFollowers&#34;) %&gt;% req_method(&#34;GET&#34;) %&gt;% req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) %&gt;% req_url_query(actor = user_did) if (!is.null(cursor)) { req &lt;- req %&gt;% req_url_query(cursor = cursor) } resp &lt;- req %&gt;% req_error( is_error = function(resp) FALSE ) %&gt;% req_perform() if (resp_status(resp) &gt;= 400) { message(&#34;An error occurred fetching followers: &#34;, resp_status_desc(resp)) print(resp_body_string(resp)) break } data &lt;- resp_body_json(resp) followers &lt;- data$followers if (length(followers) == 0) { break } all_followers &lt;- c(all_followers, followers) if (!is.null(data$cursor)) { cursor &lt;- data$cursor } else { break } Sys.sleep(0.1) # Pause to respect rate limits } # Process the followers into a tibble followers_df &lt;- map_dfr(all_followers, function(user) { tibble( did = user$did, handle = user$handle, displayName = user$displayName %||% NA_character_, description = user$description %||% NA_character_, createdAt = user$createdAt %||% NA_character_ ) }) return(followers_df) } # Get your followers followers_df &lt;- get_all_followers(session, self_did) # Exclude users who are following you from users_to_unfollow followers_handles &lt;- followers_df$handle users_to_unfollow &lt;- setdiff(users_to_unfollow, followers_handles) # If there are no users to unfollow after exclusion, exit the function if (length(users_to_unfollow) == 0) { message(&#34;No users meet the criteria for unfollowing after excluding followers.&#34;) dbDisconnect(con, shutdown = TRUE) return(NULL) } # Fetch your follow records to get the rkey (record key) message(&#34;Fetching your follow records...&#34;) get_follow_records &lt;- function(session, repo_did) { all_records &lt;- list() cursor &lt;- NULL repeat { req &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.repo.listRecords&#34;) %&gt;% req_method(&#34;GET&#34;) %&gt;% req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) %&gt;% req_url_query(repo = repo_did, collection = &#34;app.bsky.graph.follow&#34;, limit = 100) if (!is.null(cursor)) { req &lt;- req %&gt;% req_url_query(cursor = cursor) } resp &lt;- req %&gt;% req_error( is_error = function(resp) FALSE ) %&gt;% req_perform() if (resp_status(resp) &gt;= 400) { message(&#34;An error occurred fetching follow records: &#34;, resp_status_desc(resp)) print(resp_body_string(resp)) break } data &lt;- resp_body_json(resp) records &lt;- data$records if (length(records) == 0) { break } all_records &lt;- c(all_records, records) if (!is.null(data$cursor)) { cursor &lt;- data$cursor } else { break } Sys.sleep(0.1) # Pause to respect rate limits } # Process the records into a tibble records_df &lt;- map_dfr(all_records, function(record) { tibble( uri = record$uri, rkey = record$uri %&gt;% basename(), cid = record$cid, createdAt = record$value$createdAt %||% NA_character_, subject_did = record$value$subject %||% NA_character_ ) }) return(records_df) } # Get your follow records follow_records_df &lt;- get_follow_records(session, self_did) # Get the mapping of DIDs to handles from the database did_handle_map &lt;- dbGetQuery( con, &#34; SELECT did, handle FROM follow_relationships WHERE did IS NOT NULL AND handle IS NOT NULL &#34; ) # Merge handles into follow_records_df follow_records_df &lt;- follow_records_df %&gt;% left_join(did_handle_map, by = c(&#34;subject_did&#34; = &#34;did&#34;)) # For any DIDs not found in the database, optionally resolve them via API (if necessary) missing_handles &lt;- follow_records_df %&gt;% filter(is.na(handle)) %&gt;% distinct(subject_did) if (nrow(missing_handles) &gt; 0) { message(&#34;Resolving missing DIDs to handles via API...&#34;) resolve_dids_to_handles &lt;- function(dids) { handles &lt;- c() for (did in dids) { req &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.identity.resolveHandle&#34;) %&gt;% req_method(&#34;GET&#34;) %&gt;% req_url_query(did = did) resp &lt;- req %&gt;% req_error( is_error = function(resp) FALSE ) %&gt;% req_perform() if (resp_status(resp) == 200) { data &lt;- resp_body_json(resp) handles &lt;- c(handles, data$handle) } else { handles &lt;- c(handles, NA_character_) } Sys.sleep(0.1) } return(handles) } # Resolve missing DIDs resolved_handles &lt;- resolve_dids_to_handles(missing_handles$subject_did) resolved_map &lt;- tibble(subject_did = missing_handles$subject_did, handle = resolved_handles) # Update follow_records_df with resolved handles follow_records_df &lt;- follow_records_df %&gt;% left_join(resolved_map, by = &#34;subject_did&#34;, suffix = c(&#34;&#34;, &#34;.resolved&#34;)) %&gt;% mutate(handle = coalesce(handle, handle.resolved)) %&gt;% select(-handle.resolved) } # Find the records corresponding to users_to_unfollow records_to_delete &lt;- follow_records_df %&gt;% filter(handle %in% users_to_unfollow) # If there are no matching records, exit the function if (nrow(records_to_delete) == 0) { message(&#34;No matching follow records found to unfollow.&#34;) dbDisconnect(con, shutdown = TRUE) return(NULL) } # Function to unfollow a user by deleting the follow record unfollow_user &lt;- function(session, repo_did, rkey) { req &lt;- request(&#34;https://bsky.social/xrpc/com.atproto.repo.deleteRecord&#34;) %&gt;% req_method(&#34;POST&#34;) %&gt;% req_headers(Authorization = paste0(&#34;Bearer &#34;, session$accessJwt)) %&gt;% req_body_json(list( collection = &#34;app.bsky.graph.follow&#34;, repo = repo_did, rkey = rkey )) resp &lt;- req %&gt;% req_error( is_error = function(resp) FALSE ) %&gt;% req_perform() if (resp_status(resp) &gt;= 400) { message(&#34;Failed to unfollow rkey &#34;, rkey, &#34;: &#34;, resp_status_desc(resp)) print(resp_body_string(resp)) } else { message(&#34;Successfully unfollowed rkey &#34;, rkey) } } # Unfollow each user message(&#34;Unfollowing users who meet the criteria...&#34;) for (i in seq_len(nrow(records_to_delete))) { rkey &lt;- records_to_delete$rkey[i] handle &lt;- records_to_delete$handle[i] message(&#34;Unfollowing user: &#34;, handle) unfollow_user(session, self_did, rkey) Sys.sleep(0.1) # Pause to respect rate limits } # Disconnect from the database dbDisconnect(con, shutdown = TRUE) message(&#34;Unfollowing process completed.&#34;) } # Run the function unfollow_users_based_on_criteria(db_path) # Function to create a histogram of average sentiment scores of remaining follows create_histogram_of_avg_sentiment &lt;- function(db_path) { # Connect to the database con &lt;- dbConnect(duckdb::duckdb(), db_path) # Retrieve the list of users you are currently following follows_df &lt;- dbGetQuery(con, &#34;SELECT * FROM follow_relationships WHERE tag = &#39;wwd-following&#39;&#34;) # Retrieve the average sentiment scores avg_sentiment_df &lt;- dbGetQuery( con, &#34;SELECT author_handle AS handle, average_sentiment FROM wwd_following_average_sentiment&#34; ) # Merge the data to get the average sentiment scores of your current follows merged_df &lt;- follows_df %&gt;% inner_join(avg_sentiment_df, by = &#34;handle&#34;) # Disconnect from the database dbDisconnect(con, shutdown = TRUE) # Check if there are any data to plot if (nrow(merged_df) == 0) { message(&#34;No data available to plot.&#34;) return(NULL) } # Plot the histogram ggplot(merged_df, aes(x = average_sentiment)) &#43; geom_histogram( binwidth = 1, fill = &#34;steelblue&#34;, color = &#34;black&#34; ) &#43; labs(title = &#34;Histogram of Average Sentiment Scores of Remaining Follows&#34;, x = &#34;Average Sentiment Score&#34;, y = &#34;Number of Users&#34;) &#43; theme_minimal() } # Run the function to create the histogram create_histogram_of_avg_sentiment(db_path)">
  <meta itemprop="datePublished" content="2024-11-24T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-11-24T00:00:00+00:00">
  <meta itemprop="wordCount" content="2739">
  <meta itemprop="image" content="http://localhost:4321/blog/bsky_unfollow_negative_people/featured.jpg">
  <meta itemprop="keywords" content="R,DuckDB,Bluesky">
  
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RJ8HKRJ16Q"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RJ8HKRJ16Q');
        }
      </script>
  <!--[if IE]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
  
  
  <link rel="stylesheet" href="/style.main.min.0820a865770f259724d61d170adbb19db040647ecaa3b2023c16f04ada7fc7d2.css" integrity="sha256-CCCoZXcPJZck1h0XCtuxnbBAZH7Ko7ICPBbwStp/x9I=" media="screen">
  
  
  <script src="/panelset.min.ed1ac24b6e16f4e2481e3d1d098ae66f5bc77438aef619e6e266d8ac5b00dc72.js" type="text/javascript"></script>
  
  
  <script src="/main.min.f0b39b51e43cf3881368fb093708a9d3b3499e674af4b4e47e27e512a5d411e2.js" type="text/javascript"></script>
</head>
<body>
      <div class="grid-container single">
<header class="site-header pt4 pb2 mb4 bb b--transparent ph5 headroom z-max" role="banner">
  <nav class="site-nav db dt-l w-100" role="navigation">
    <a class="site-brand db dtc-l v-mid link no-underline w-100 w-33-l tc tl-l" href="http://localhost:4321/" title="Home">
      <img src="/img/logo_leaf.png" class="dib db-l h2 w-auto" alt="Warp and Weft Data">
    </a>
    <div class="site-links db dtc-l v-mid w-100 w-47-l tc tr-l mt3 mt0-l ttu tracked">
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 " href="/about/" title="About Steve Ewing">About</a>
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 active" href="/blog/" title="Blog">Blog</a>
      
      
    </div>
  </nav>
</header>

<main class="page-main pa4" role="main">
  <section class="page-content mw7 center">
    <article class="post-content pa0 ph4-l">
      <header class="post-header">
        <h1 class="f1 lh-solid measure-narrow mb3 fw4">Bluesky Unfollowing Negative Follows</h1>
        <h4 class="f4 mt0 mb4 lh-title measure">If you don&#39;t follow me and are negative you can take a hike</h4>
        <p class="f6 measure lh-copy mv1">By Steve Ewing in <a href="http://localhost:4321/categories/bluesky">Bluesky</a> </p>
        <p class="f7 db mv0 ttu">November 24, 2024</p>

      

      </header>
      <section class="post-body pt5 pb4">
        <p>I followed a ton of people using the new starter packs. Now I&rsquo;m going to keep all my mutuals and unfollow the people I&rsquo;m following who aren&rsquo;t following me back and who have a net negative sentiment score on their posts.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Load necessary libraries</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(DBI)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(duckdb)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(tidyverse)
</span></span></code></pre></div><pre tabindex="0"><code>## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
## ✔ dplyr     1.1.4     ✔ readr     2.1.5
## ✔ forcats   1.0.0     ✔ stringr   1.5.1
## ✔ ggplot2   3.5.1     ✔ tibble    3.2.1
## ✔ lubridate 1.9.3     ✔ tidyr     1.3.1
## ✔ purrr     1.0.2     
## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
## ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(tidytext)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(httr2)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(parsedate)  
</span></span></code></pre></div><pre tabindex="0"><code>## 
## Attaching package: &#39;parsedate&#39;
## 
## The following object is masked from &#39;package:readr&#39;:
## 
##     parse_date
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>get_follow_relationships <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(db_path) {
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">library</span>(tidyverse)
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">library</span>(httr2)
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">library</span>(DBI)
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">library</span>(duckdb)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Create a logged-in API session object</span>
</span></span><span style="display:flex;"><span>  session <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">request</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/com.atproto.server.createSession&#34;</span>) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">req_method</span>(<span style="color:#d14">&#34;POST&#34;</span>) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">req_body_json</span>(<span style="color:#900;font-weight:bold">list</span>(
</span></span><span style="display:flex;"><span>      identifier <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">Sys.getenv</span>(<span style="color:#d14">&#34;BLUESKY_APP_USER&#34;</span>),
</span></span><span style="display:flex;"><span>      password <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">Sys.getenv</span>(<span style="color:#d14">&#34;BLUESKY_APP_PASS&#34;</span>)
</span></span><span style="display:flex;"><span>    )) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">req_perform</span>() <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">resp_body_json</span>()
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get your own DID (Decentralized Identifier)</span>
</span></span><span style="display:flex;"><span>  self_handle <span style="color:#000;font-weight:bold">&lt;-</span> session<span style="color:#000;font-weight:bold">$</span>handle
</span></span><span style="display:flex;"><span>  self_did <span style="color:#000;font-weight:bold">&lt;-</span> session<span style="color:#000;font-weight:bold">$</span>did
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Function to get all follows or followers</span>
</span></span><span style="display:flex;"><span>  get_all_follows <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(endpoint_url, user_did) {
</span></span><span style="display:flex;"><span>    all_users <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>()
</span></span><span style="display:flex;"><span>    cursor <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">repeat</span> {
</span></span><span style="display:flex;"><span>      req <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">request</span>(endpoint_url) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_method</span>(<span style="color:#d14">&#34;GET&#34;</span>) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_headers</span>(Authorization <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#34;Bearer &#34;</span>, session<span style="color:#000;font-weight:bold">$</span>accessJwt)) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_url_query</span>(actor <span style="color:#000;font-weight:bold">=</span> user_did)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(cursor)) {
</span></span><span style="display:flex;"><span>        req <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">|&gt;</span> <span style="color:#900;font-weight:bold">req_url_query</span>(cursor <span style="color:#000;font-weight:bold">=</span> cursor)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      resp <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_error</span>(
</span></span><span style="display:flex;"><span>          is_error <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">function</span>(resp)
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>        ) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_perform</span>()
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">resp_status</span>(resp) <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#099">400</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;An error occurred fetching data: &#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#900;font-weight:bold">resp_status_desc</span>(resp))
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">print</span>(<span style="color:#900;font-weight:bold">resp_body_string</span>(resp))
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      data <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">resp_body_json</span>(resp)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Determine if fetching followers or following</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#d14">&#34;followers&#34;</span> <span style="color:#000;font-weight:bold">%in%</span> <span style="color:#900;font-weight:bold">names</span>(data)) {
</span></span><span style="display:flex;"><span>        users <span style="color:#000;font-weight:bold">&lt;-</span> data<span style="color:#000;font-weight:bold">$</span>followers
</span></span><span style="display:flex;"><span>      } <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> (<span style="color:#d14">&#34;follows&#34;</span> <span style="color:#000;font-weight:bold">%in%</span> <span style="color:#900;font-weight:bold">names</span>(data)) {
</span></span><span style="display:flex;"><span>        users <span style="color:#000;font-weight:bold">&lt;-</span> data<span style="color:#000;font-weight:bold">$</span>follows
</span></span><span style="display:flex;"><span>      } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Unexpected data format.&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Check if users list is empty</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">length</span>(users) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      all_users <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(all_users, users)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(data<span style="color:#000;font-weight:bold">$</span>cursor)) {
</span></span><span style="display:flex;"><span>        cursor <span style="color:#000;font-weight:bold">&lt;-</span> data<span style="color:#000;font-weight:bold">$</span>cursor
</span></span><span style="display:flex;"><span>      } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">Sys.sleep</span>(<span style="color:#099">0.1</span>) <span style="color:#998;font-style:italic"># Pause to respect rate limits</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Process the users into a tibble</span>
</span></span><span style="display:flex;"><span>    users_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">map_dfr</span>(all_users, <span style="color:#000;font-weight:bold">function</span>(user) {
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">tibble</span>(
</span></span><span style="display:flex;"><span>        did <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>did,
</span></span><span style="display:flex;"><span>        handle <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>handle,
</span></span><span style="display:flex;"><span>        displayName <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>displayName <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>        description <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>description <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>        createdAt <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>createdAt <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span>(users_df)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get followers</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Fetching your followers...&#34;</span>)
</span></span><span style="display:flex;"><span>  followers_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">get_all_follows</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/app.bsky.graph.getFollowers&#34;</span>,
</span></span><span style="display:flex;"><span>                                  self_did)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get following</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Fetching users you are following...&#34;</span>)
</span></span><span style="display:flex;"><span>  following_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">get_all_follows</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/app.bsky.graph.getFollows&#34;</span>,
</span></span><span style="display:flex;"><span>                                  self_did)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Identify relationships</span>
</span></span><span style="display:flex;"><span>  followers_handles <span style="color:#000;font-weight:bold">&lt;-</span> followers_df<span style="color:#000;font-weight:bold">$</span>handle
</span></span><span style="display:flex;"><span>  following_handles <span style="color:#000;font-weight:bold">&lt;-</span> following_df<span style="color:#000;font-weight:bold">$</span>handle
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Users you are following who aren&#39;t following you back</span>
</span></span><span style="display:flex;"><span>  wwd_following <span style="color:#000;font-weight:bold">&lt;-</span> following_df <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">filter</span>(<span style="color:#000;font-weight:bold">!</span>handle <span style="color:#000;font-weight:bold">%in%</span> followers_handles) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">mutate</span>(tag <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;wwd-following&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Users who are following you but you aren&#39;t following back</span>
</span></span><span style="display:flex;"><span>  wwd_follower <span style="color:#000;font-weight:bold">&lt;-</span> followers_df <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">filter</span>(<span style="color:#000;font-weight:bold">!</span>handle <span style="color:#000;font-weight:bold">%in%</span> following_handles) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">mutate</span>(tag <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;wwd-follower&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Mutual follows</span>
</span></span><span style="display:flex;"><span>  wwd_mutuals <span style="color:#000;font-weight:bold">&lt;-</span> following_df <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">filter</span>(handle <span style="color:#000;font-weight:bold">%in%</span> followers_handles) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">mutate</span>(tag <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;wwd-mutuals&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Combine all</span>
</span></span><span style="display:flex;"><span>  relationships_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_rows</span>(wwd_following, wwd_follower, wwd_mutuals)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Connect to the database</span>
</span></span><span style="display:flex;"><span>  con <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbConnect</span>(duckdb<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">duckdb</span>(), db_path)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Save relationships to the database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbWriteTable</span>(con, <span style="color:#d14">&#34;follow_relationships&#34;</span>, relationships_df, overwrite <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Disconnect from the database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Follow relationships have been stored in the database.&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Return the data frame</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span>(relationships_df)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Define the path to your database</span>
</span></span><span style="display:flex;"><span>db_path <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#d14">&#34;C:/Users/steph/OneDrive/warp_and_weft_data/content/blog/bsky_sentiment_index/bluesky_data.duckdb&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Call the function with the database path</span>
</span></span><span style="display:flex;"><span>relationships <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">get_follow_relationships</span>(db_path)
</span></span></code></pre></div><pre tabindex="0"><code>## Fetching your followers...
## Fetching users you are following...
## Follow relationships have been stored in the database.
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># View the results</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">print</span>(relationships)
</span></span></code></pre></div><pre tabindex="0"><code>## # A tibble: 972 × 6
##    did                            handle displayName description createdAt tag  
##    &lt;chr&gt;                          &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;
##  1 did:plc:qofqpqau42nmrqgtcqpr4… tooma… &#34;seven ex … &#34;humanoid … 2024-11-… wwd-…
##  2 did:plc:4dlr3yhphrh6vc7q627mc… aklot… &#34;Alex Klot… &#34;Physics p… 2023-06-… wwd-…
##  3 did:plc:yz7ogsukyb7j6mup6udg5… annag… &#34;Anna Hugh… &#34;\U0001f30… 2023-05-… wwd-…
##  4 did:plc:uwscsrt6wq2pahbzef2nc… sanja… &#34;sanjana c… &#34;nuclear a… 2023-04-… wwd-…
##  5 did:plc:spanui6736cbvrbrci2hx… astro… &#34;Brandon B… &#34;computati… 2023-06-… wwd-…
##  6 did:plc:5ufuqy3qstws4yzjuixf4… frogs… &#34;anna !!! … &#34;| she/her… 2023-04-… wwd-…
##  7 did:plc:gvcmzzacbgwgttvcxzytp… astro… &#34;athena, g… &#34;astrophys… 2023-08-… wwd-…
##  8 did:plc:my5x3kz6owobc5mcncdo4… adeen… &#34;Dr. Adeen… &#34;Planetary… 2023-06-… wwd-…
##  9 did:plc:2bppr6lzjxvpcrp5lho6j… focus… &#34;katie&#34;     &#34;opinions … 2023-04-… wwd-…
## 10 did:plc:qzmgfnhb76ffudt7utnmy… yonib… &#34;Yoni Bran… &#34;astrologe… 2023-05-… wwd-…
## # ℹ 962 more rows
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Function to get posts from a vector of handles, fetching only new posts and writing to db as it fetches</span>
</span></span><span style="display:flex;"><span>get_posts_from_handles <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(handles, session, db_path) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Connect to the database</span>
</span></span><span style="display:flex;"><span>  con <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbConnect</span>(duckdb<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">duckdb</span>(), db_path)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Loop over each handle</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">for</span> (handle <span style="color:#000;font-weight:bold">in</span> handles) {
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Fetching posts for handle: &#34;</span>, handle)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Get the latest record_createdAt for this handle from the posts table</span>
</span></span><span style="display:flex;"><span>    latest_time_query <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">sprintf</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#d14">&#34;SELECT MAX(record_createdAt) as latest_time FROM posts WHERE author_handle = &#39;%s&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>      handle
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    latest_time_result <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(con, latest_time_query)
</span></span><span style="display:flex;"><span>    latest_time <span style="color:#000;font-weight:bold">&lt;-</span> latest_time_result<span style="color:#000;font-weight:bold">$</span>latest_time[1]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># If there is no latest_time (i.e., no posts for this handle), set to NULL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">is.na</span>(latest_time) <span style="color:#000;font-weight:bold">||</span> <span style="color:#900;font-weight:bold">is.null</span>(latest_time)) {
</span></span><span style="display:flex;"><span>      latest_time <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;No existing posts found for handle: &#34;</span>, handle)
</span></span><span style="display:flex;"><span>    } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Latest post time for &#34;</span>, handle, <span style="color:#d14">&#34;: &#34;</span>, latest_time)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Initialize variables for fetching posts</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># We will process and write posts as we fetch them</span>
</span></span><span style="display:flex;"><span>    cursor <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>    keep_fetching <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">TRUE</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">repeat</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Construct the GET request</span>
</span></span><span style="display:flex;"><span>      req <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">request</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/app.bsky.feed.getAuthorFeed&#34;</span>) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_method</span>(<span style="color:#d14">&#34;GET&#34;</span>) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_headers</span>(Authorization <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#34;Bearer &#34;</span>, session<span style="color:#000;font-weight:bold">$</span>accessJwt)) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_url_query</span>(actor <span style="color:#000;font-weight:bold">=</span> handle)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># If cursor is not NULL, add it to the query</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(cursor)) {
</span></span><span style="display:flex;"><span>        req <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">|&gt;</span> <span style="color:#900;font-weight:bold">req_url_query</span>(cursor <span style="color:#000;font-weight:bold">=</span> cursor)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Perform the request</span>
</span></span><span style="display:flex;"><span>      resp <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_error</span>(
</span></span><span style="display:flex;"><span>          is_error <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">function</span>(resp)
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>        ) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_perform</span>()
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Check if the response is an error</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">resp_status</span>(resp) <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#099">400</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;An error occurred fetching posts for &#34;</span>,
</span></span><span style="display:flex;"><span>                handle,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;: &#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#900;font-weight:bold">resp_status_desc</span>(resp))
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># Optionally, print the response body for more details</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">print</span>(<span style="color:#900;font-weight:bold">resp_body_string</span>(resp))
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Parse the response</span>
</span></span><span style="display:flex;"><span>      feed_data <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">resp_body_json</span>(resp)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Check if feed is empty</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">length</span>(feed_data<span style="color:#000;font-weight:bold">$</span>feed) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;No posts found for handle: &#34;</span>, handle)
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Process posts and check timestamps</span>
</span></span><span style="display:flex;"><span>      posts_to_add <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">for</span> (post <span style="color:#000;font-weight:bold">in</span> feed_data<span style="color:#000;font-weight:bold">$</span>feed) {
</span></span><span style="display:flex;"><span>        post_time <span style="color:#000;font-weight:bold">&lt;-</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>record<span style="color:#000;font-weight:bold">$</span>createdAt <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (post_time <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">next</span>  <span style="color:#998;font-style:italic"># Skip if no timestamp</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># Parse the timestamps using parsedate::parse_iso_8601</span>
</span></span><span style="display:flex;"><span>        post_time_parsed <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">parse_iso_8601</span>(post_time)
</span></span><span style="display:flex;"><span>        latest_time_parsed <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(latest_time))
</span></span><span style="display:flex;"><span>          <span style="color:#900;font-weight:bold">parse_iso_8601</span>(latest_time)
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># Compare post_time with latest_time</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(latest_time_parsed) <span style="color:#000;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.na</span>(post_time_parsed) <span style="color:#000;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            post_time_parsed <span style="color:#000;font-weight:bold">&lt;=</span> latest_time_parsed) {
</span></span><span style="display:flex;"><span>          <span style="color:#998;font-style:italic"># Reached posts we&#39;ve already fetched</span>
</span></span><span style="display:flex;"><span>          keep_fetching <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>        } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#998;font-style:italic"># New post, add to the list</span>
</span></span><span style="display:flex;"><span>          posts_to_add <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(posts_to_add, <span style="color:#900;font-weight:bold">list</span>(post))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># If there are new posts to add, process and write them to the database</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">length</span>(posts_to_add) <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>        posts_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">map_dfr</span>(posts_to_add, <span style="color:#000;font-weight:bold">function</span>(post) {
</span></span><span style="display:flex;"><span>          <span style="color:#900;font-weight:bold">tibble</span>(
</span></span><span style="display:flex;"><span>            uri <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>uri,
</span></span><span style="display:flex;"><span>            cid <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>cid,
</span></span><span style="display:flex;"><span>            author_did <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>author<span style="color:#000;font-weight:bold">$</span>did <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>            author_handle <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>author<span style="color:#000;font-weight:bold">$</span>handle <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>            author_displayName <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>author<span style="color:#000;font-weight:bold">$</span>displayName <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>            record_type <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>record<span style="color:#000;font-weight:bold">$</span>`$type` <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>            record_text <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>record<span style="color:#000;font-weight:bold">$</span>text <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>            record_createdAt <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>record<span style="color:#000;font-weight:bold">$</span>createdAt <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>            reply_root <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>record<span style="color:#000;font-weight:bold">$</span>reply<span style="color:#000;font-weight:bold">$</span>root<span style="color:#000;font-weight:bold">$</span>uri <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>            reply_parent <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>record<span style="color:#000;font-weight:bold">$</span>reply<span style="color:#000;font-weight:bold">$</span>parent<span style="color:#000;font-weight:bold">$</span>uri <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>            repost_count <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>repostCount <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_integer_</span>,
</span></span><span style="display:flex;"><span>            reply_count <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>replyCount <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_integer_</span>,
</span></span><span style="display:flex;"><span>            like_count <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>likeCount <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_integer_</span>,
</span></span><span style="display:flex;"><span>            indexed_at <span style="color:#000;font-weight:bold">=</span> post<span style="color:#000;font-weight:bold">$</span>post<span style="color:#000;font-weight:bold">$</span>indexedAt <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>
</span></span><span style="display:flex;"><span>          )
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># Write the new posts to the &#39;posts&#39; table, appending</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">dbWriteTable</span>(con, <span style="color:#d14">&#34;posts&#34;</span>, posts_df, append <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Wrote &#34;</span>, <span style="color:#900;font-weight:bold">nrow</span>(posts_df), <span style="color:#d14">&#34; new posts for handle: &#34;</span>, handle)
</span></span><span style="display:flex;"><span>      } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;No new posts to add for handle: &#34;</span>, handle)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Break the loop if we&#39;ve reached existing posts</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>keep_fetching) {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Update cursor</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(feed_data<span style="color:#000;font-weight:bold">$</span>cursor)) {
</span></span><span style="display:flex;"><span>        cursor <span style="color:#000;font-weight:bold">&lt;-</span> feed_data<span style="color:#000;font-weight:bold">$</span>cursor
</span></span><span style="display:flex;"><span>      } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># No more pages to fetch</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Optional: Pause to respect rate limits</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">Sys.sleep</span>(<span style="color:#099">0.1</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Disconnect from the database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>)  <span style="color:#998;font-style:italic"># Keep the database running for other operations</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Function to compute sentiment scores for new posts</span>
</span></span><span style="display:flex;"><span>compute_sentiment_scores_for_new_posts <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(db_path) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Connect to the database</span>
</span></span><span style="display:flex;"><span>  con <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbConnect</span>(duckdb<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">duckdb</span>(), db_path)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get the list of uris of posts that already have sentiment scores</span>
</span></span><span style="display:flex;"><span>  existing_scores <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(con, <span style="color:#d14">&#34;SELECT uri FROM post_sentiment_scores&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get the list of uris of all posts</span>
</span></span><span style="display:flex;"><span>  all_posts <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(con, <span style="color:#d14">&#34;SELECT uri, record_text FROM posts&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Filter posts that don&#39;t have sentiment scores yet</span>
</span></span><span style="display:flex;"><span>  posts_to_score <span style="color:#000;font-weight:bold">&lt;-</span> all_posts <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">filter</span>(<span style="color:#000;font-weight:bold">!</span>uri <span style="color:#000;font-weight:bold">%in%</span> existing_scores<span style="color:#000;font-weight:bold">$</span>uri) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">filter</span>(<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.na</span>(record_text))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># If there are no new posts to score, exit the function</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">nrow</span>(posts_to_score) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;No new posts to compute sentiment scores for.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span>(<span style="color:#000;font-weight:bold">NULL</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Tokenize the text</span>
</span></span><span style="display:flex;"><span>  posts_tokens <span style="color:#000;font-weight:bold">&lt;-</span> posts_to_score <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">unnest_tokens</span>(word, record_text)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get the AFINN sentiment lexicon</span>
</span></span><span style="display:flex;"><span>  afinn <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">get_sentiments</span>(<span style="color:#d14">&#34;afinn&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Join tokens with sentiment lexicon</span>
</span></span><span style="display:flex;"><span>  posts_sentiment <span style="color:#000;font-weight:bold">&lt;-</span> posts_tokens <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">inner_join</span>(afinn, by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;word&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Compute sentiment score per post</span>
</span></span><span style="display:flex;"><span>  post_sentiment_scores <span style="color:#000;font-weight:bold">&lt;-</span> posts_sentiment <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">group_by</span>(uri) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">summarise</span>(sentiment_score <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">sum</span>(value), .groups <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;drop&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Handle posts without sentiment words</span>
</span></span><span style="display:flex;"><span>  all_uris <span style="color:#000;font-weight:bold">&lt;-</span> posts_to_score<span style="color:#000;font-weight:bold">$</span>uri
</span></span><span style="display:flex;"><span>  post_sentiment_scores <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(uri <span style="color:#000;font-weight:bold">=</span> all_uris) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">left_join</span>(post_sentiment_scores, by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;uri&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">mutate</span>(sentiment_score <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">replace_na</span>(sentiment_score, <span style="color:#099">0</span>))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Write the new sentiment scores to the database, appending</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbWriteTable</span>(con,
</span></span><span style="display:flex;"><span>               <span style="color:#d14">&#34;post_sentiment_scores&#34;</span>,
</span></span><span style="display:flex;"><span>               post_sentiment_scores,
</span></span><span style="display:flex;"><span>               append <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Disconnect from the database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Sentiment scores computed for new posts.&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Main script to get posts and compute average sentiment scores</span>
</span></span><span style="display:flex;"><span>main <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Create a logged-in API session object once</span>
</span></span><span style="display:flex;"><span>  session <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">request</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/com.atproto.server.createSession&#34;</span>) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">req_method</span>(<span style="color:#d14">&#34;POST&#34;</span>) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">req_body_json</span>(<span style="color:#900;font-weight:bold">list</span>(
</span></span><span style="display:flex;"><span>      identifier <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">Sys.getenv</span>(<span style="color:#d14">&#34;BLUESKY_APP_USER&#34;</span>),
</span></span><span style="display:flex;"><span>      password <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">Sys.getenv</span>(<span style="color:#d14">&#34;BLUESKY_APP_PASS&#34;</span>)
</span></span><span style="display:flex;"><span>    )) <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">req_perform</span>() <span style="color:#000;font-weight:bold">|&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">resp_body_json</span>()
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Connect to the database</span>
</span></span><span style="display:flex;"><span>  con <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbConnect</span>(duckdb<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">duckdb</span>(), db_path)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get the list of &#39;wwd-following&#39; handles</span>
</span></span><span style="display:flex;"><span>  wwd_following_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(con,
</span></span><span style="display:flex;"><span>                                 <span style="color:#d14">&#34;SELECT * FROM follow_relationships WHERE tag = &#39;wwd-following&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>  wwd_following_handles <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">unique</span>(wwd_following_df<span style="color:#000;font-weight:bold">$</span>handle)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Disconnect from the database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Fetch posts for the &#39;wwd-following&#39; handles, only new posts, writing to db as we fetch</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">get_posts_from_handles</span>(wwd_following_handles, session, db_path)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Compute sentiment scores for new posts</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">compute_sentiment_scores_for_new_posts</span>(db_path)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Connect to the database</span>
</span></span><span style="display:flex;"><span>  con <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbConnect</span>(duckdb<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">duckdb</span>(), db_path)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Build the list of handles for the SQL query</span>
</span></span><span style="display:flex;"><span>  handle_list <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">paste</span>(<span style="color:#900;font-weight:bold">sprintf</span>(<span style="color:#d14">&#34;&#39;%s&#39;&#34;</span>, wwd_following_handles), collapse <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;,&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Build the SQL query using sprintf</span>
</span></span><span style="display:flex;"><span>  sql_query <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">sprintf</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    SELECT p.*, s.sentiment_score
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    FROM posts p
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    LEFT JOIN post_sentiment_scores s ON p.uri = s.uri
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    WHERE p.author_handle IN (%s)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;</span>,
</span></span><span style="display:flex;"><span>handle_list
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Run the query</span>
</span></span><span style="display:flex;"><span>  posts_with_sentiment <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(con, sql_query)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Disconnect from the database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Compute average sentiment score per person</span>
</span></span><span style="display:flex;"><span>  average_sentiment_per_person <span style="color:#000;font-weight:bold">&lt;-</span> posts_with_sentiment <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">group_by</span>(author_handle) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">summarise</span>(average_sentiment <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">mean</span>(sentiment_score, na.rm <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>),
</span></span><span style="display:flex;"><span>              .groups <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;drop&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># View the results</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">print</span>(average_sentiment_per_person)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Optionally, save the results to the database</span>
</span></span><span style="display:flex;"><span>  con <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbConnect</span>(duckdb<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">duckdb</span>(), db_path)
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbWriteTable</span>(
</span></span><span style="display:flex;"><span>    con,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;wwd_following_average_sentiment&#34;</span>,
</span></span><span style="display:flex;"><span>    average_sentiment_per_person,
</span></span><span style="display:flex;"><span>    overwrite <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Average sentiment scores computed and stored.&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Run the main function</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">main</span>()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Function to unfollow users based on criteria, excluding those who are following you</span>
</span></span><span style="display:flex;"><span>unfollow_users_based_on_criteria <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(db_path) {
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Create a logged-in API session object</span>
</span></span><span style="display:flex;"><span>  session <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">request</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/com.atproto.server.createSession&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">req_method</span>(<span style="color:#d14">&#34;POST&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">req_body_json</span>(<span style="color:#900;font-weight:bold">list</span>(
</span></span><span style="display:flex;"><span>      identifier <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">Sys.getenv</span>(<span style="color:#d14">&#34;BLUESKY_APP_USER&#34;</span>),
</span></span><span style="display:flex;"><span>      password <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">Sys.getenv</span>(<span style="color:#d14">&#34;BLUESKY_APP_PASS&#34;</span>)
</span></span><span style="display:flex;"><span>    )) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">req_perform</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">resp_body_json</span>()
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get your own DID (Decentralized Identifier)</span>
</span></span><span style="display:flex;"><span>  self_did <span style="color:#000;font-weight:bold">&lt;-</span> session<span style="color:#000;font-weight:bold">$</span>did
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Connect to the database</span>
</span></span><span style="display:flex;"><span>  con <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbConnect</span>(duckdb<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">duckdb</span>(), db_path)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Retrieve users with 0 posts</span>
</span></span><span style="display:flex;"><span>  users_with_zero_posts <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(
</span></span><span style="display:flex;"><span>    con,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    SELECT handle
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    FROM follow_relationships
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    WHERE tag = &#39;wwd-following&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    AND handle NOT IN (SELECT DISTINCT author_handle FROM posts)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Retrieve users with average sentiment score below -5</span>
</span></span><span style="display:flex;"><span>  users_with_low_sentiment <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(
</span></span><span style="display:flex;"><span>    con,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    SELECT author_handle AS handle
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    FROM wwd_following_average_sentiment
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    WHERE average_sentiment &lt; 1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Combine the users to unfollow</span>
</span></span><span style="display:flex;"><span>  users_to_unfollow <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">unique</span>(<span style="color:#900;font-weight:bold">c</span>(
</span></span><span style="display:flex;"><span>    users_with_zero_posts<span style="color:#000;font-weight:bold">$</span>handle,
</span></span><span style="display:flex;"><span>    users_with_low_sentiment<span style="color:#000;font-weight:bold">$</span>handle
</span></span><span style="display:flex;"><span>  ))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Retrieve the list of users who are following you</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Fetching your followers...&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Function to get all followers</span>
</span></span><span style="display:flex;"><span>  get_all_followers <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(session, user_did) {
</span></span><span style="display:flex;"><span>    all_followers <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>()
</span></span><span style="display:flex;"><span>    cursor <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">repeat</span> {
</span></span><span style="display:flex;"><span>      req <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">request</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/app.bsky.graph.getFollowers&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_method</span>(<span style="color:#d14">&#34;GET&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_headers</span>(Authorization <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#34;Bearer &#34;</span>, session<span style="color:#000;font-weight:bold">$</span>accessJwt)) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_url_query</span>(actor <span style="color:#000;font-weight:bold">=</span> user_did)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(cursor)) {
</span></span><span style="display:flex;"><span>        req <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">req_url_query</span>(cursor <span style="color:#000;font-weight:bold">=</span> cursor)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      resp <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_error</span>(
</span></span><span style="display:flex;"><span>          is_error <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">function</span>(resp)
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>        ) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_perform</span>()
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">resp_status</span>(resp) <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#099">400</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;An error occurred fetching followers: &#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#900;font-weight:bold">resp_status_desc</span>(resp))
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">print</span>(<span style="color:#900;font-weight:bold">resp_body_string</span>(resp))
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      data <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">resp_body_json</span>(resp)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      followers <span style="color:#000;font-weight:bold">&lt;-</span> data<span style="color:#000;font-weight:bold">$</span>followers
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">length</span>(followers) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      all_followers <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(all_followers, followers)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(data<span style="color:#000;font-weight:bold">$</span>cursor)) {
</span></span><span style="display:flex;"><span>        cursor <span style="color:#000;font-weight:bold">&lt;-</span> data<span style="color:#000;font-weight:bold">$</span>cursor
</span></span><span style="display:flex;"><span>      } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">Sys.sleep</span>(<span style="color:#099">0.1</span>) <span style="color:#998;font-style:italic"># Pause to respect rate limits</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Process the followers into a tibble</span>
</span></span><span style="display:flex;"><span>    followers_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">map_dfr</span>(all_followers, <span style="color:#000;font-weight:bold">function</span>(user) {
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">tibble</span>(
</span></span><span style="display:flex;"><span>        did <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>did,
</span></span><span style="display:flex;"><span>        handle <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>handle,
</span></span><span style="display:flex;"><span>        displayName <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>displayName <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>        description <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>description <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>        createdAt <span style="color:#000;font-weight:bold">=</span> user<span style="color:#000;font-weight:bold">$</span>createdAt <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span>(followers_df)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get your followers</span>
</span></span><span style="display:flex;"><span>  followers_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">get_all_followers</span>(session, self_did)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Exclude users who are following you from users_to_unfollow</span>
</span></span><span style="display:flex;"><span>  followers_handles <span style="color:#000;font-weight:bold">&lt;-</span> followers_df<span style="color:#000;font-weight:bold">$</span>handle
</span></span><span style="display:flex;"><span>  users_to_unfollow <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">setdiff</span>(users_to_unfollow, followers_handles)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># If there are no users to unfollow after exclusion, exit the function</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">length</span>(users_to_unfollow) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;No users meet the criteria for unfollowing after excluding followers.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span>(<span style="color:#000;font-weight:bold">NULL</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Fetch your follow records to get the rkey (record key)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Fetching your follow records...&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  get_follow_records <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(session, repo_did) {
</span></span><span style="display:flex;"><span>    all_records <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>()
</span></span><span style="display:flex;"><span>    cursor <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">repeat</span> {
</span></span><span style="display:flex;"><span>      req <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">request</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/com.atproto.repo.listRecords&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_method</span>(<span style="color:#d14">&#34;GET&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_headers</span>(Authorization <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#34;Bearer &#34;</span>, session<span style="color:#000;font-weight:bold">$</span>accessJwt)) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_url_query</span>(repo <span style="color:#000;font-weight:bold">=</span> repo_did,
</span></span><span style="display:flex;"><span>                      collection <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;app.bsky.graph.follow&#34;</span>,
</span></span><span style="display:flex;"><span>                      limit <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">100</span>)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(cursor)) {
</span></span><span style="display:flex;"><span>        req <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">req_url_query</span>(cursor <span style="color:#000;font-weight:bold">=</span> cursor)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      resp <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_error</span>(
</span></span><span style="display:flex;"><span>          is_error <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">function</span>(resp)
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>        ) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">req_perform</span>()
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">resp_status</span>(resp) <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#099">400</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;An error occurred fetching follow records: &#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#900;font-weight:bold">resp_status_desc</span>(resp))
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">print</span>(<span style="color:#900;font-weight:bold">resp_body_string</span>(resp))
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      data <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">resp_body_json</span>(resp)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      records <span style="color:#000;font-weight:bold">&lt;-</span> data<span style="color:#000;font-weight:bold">$</span>records
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">length</span>(records) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      all_records <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(all_records, records)
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(data<span style="color:#000;font-weight:bold">$</span>cursor)) {
</span></span><span style="display:flex;"><span>        cursor <span style="color:#000;font-weight:bold">&lt;-</span> data<span style="color:#000;font-weight:bold">$</span>cursor
</span></span><span style="display:flex;"><span>      } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">Sys.sleep</span>(<span style="color:#099">0.1</span>) <span style="color:#998;font-style:italic"># Pause to respect rate limits</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Process the records into a tibble</span>
</span></span><span style="display:flex;"><span>    records_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">map_dfr</span>(all_records, <span style="color:#000;font-weight:bold">function</span>(record) {
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">tibble</span>(
</span></span><span style="display:flex;"><span>        uri <span style="color:#000;font-weight:bold">=</span> record<span style="color:#000;font-weight:bold">$</span>uri,
</span></span><span style="display:flex;"><span>        rkey <span style="color:#000;font-weight:bold">=</span> record<span style="color:#000;font-weight:bold">$</span>uri <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">basename</span>(),
</span></span><span style="display:flex;"><span>        cid <span style="color:#000;font-weight:bold">=</span> record<span style="color:#000;font-weight:bold">$</span>cid,
</span></span><span style="display:flex;"><span>        createdAt <span style="color:#000;font-weight:bold">=</span> record<span style="color:#000;font-weight:bold">$</span>value<span style="color:#000;font-weight:bold">$</span>createdAt <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>,
</span></span><span style="display:flex;"><span>        subject_did <span style="color:#000;font-weight:bold">=</span> record<span style="color:#000;font-weight:bold">$</span>value<span style="color:#000;font-weight:bold">$</span>subject <span style="color:#000;font-weight:bold">%||%</span> <span style="color:#000;font-weight:bold">NA_character_</span>
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span>(records_df)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get your follow records</span>
</span></span><span style="display:flex;"><span>  follow_records_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">get_follow_records</span>(session, self_did)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Get the mapping of DIDs to handles from the database</span>
</span></span><span style="display:flex;"><span>  did_handle_map <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(
</span></span><span style="display:flex;"><span>    con,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    SELECT did, handle
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    FROM follow_relationships
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    WHERE did IS NOT NULL AND handle IS NOT NULL
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Merge handles into follow_records_df</span>
</span></span><span style="display:flex;"><span>  follow_records_df <span style="color:#000;font-weight:bold">&lt;-</span> follow_records_df <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">left_join</span>(did_handle_map, by <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#34;subject_did&#34;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;did&#34;</span>))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># For any DIDs not found in the database, optionally resolve them via API (if necessary)</span>
</span></span><span style="display:flex;"><span>  missing_handles <span style="color:#000;font-weight:bold">&lt;-</span> follow_records_df <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">filter</span>(<span style="color:#900;font-weight:bold">is.na</span>(handle)) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">distinct</span>(subject_did)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">nrow</span>(missing_handles) <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Resolving missing DIDs to handles via API...&#34;</span>)
</span></span><span style="display:flex;"><span>    resolve_dids_to_handles <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(dids) {
</span></span><span style="display:flex;"><span>      handles <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">for</span> (did <span style="color:#000;font-weight:bold">in</span> dids) {
</span></span><span style="display:flex;"><span>        req <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">request</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/com.atproto.identity.resolveHandle&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>          <span style="color:#900;font-weight:bold">req_method</span>(<span style="color:#d14">&#34;GET&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>          <span style="color:#900;font-weight:bold">req_url_query</span>(did <span style="color:#000;font-weight:bold">=</span> did)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        resp <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>          <span style="color:#900;font-weight:bold">req_error</span>(
</span></span><span style="display:flex;"><span>            is_error <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">function</span>(resp)
</span></span><span style="display:flex;"><span>              <span style="color:#000;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>          ) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>          <span style="color:#900;font-weight:bold">req_perform</span>()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">resp_status</span>(resp) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">200</span>) {
</span></span><span style="display:flex;"><span>          data <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">resp_body_json</span>(resp)
</span></span><span style="display:flex;"><span>          handles <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(handles, data<span style="color:#000;font-weight:bold">$</span>handle)
</span></span><span style="display:flex;"><span>        } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>          handles <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(handles, <span style="color:#000;font-weight:bold">NA_character_</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#900;font-weight:bold">Sys.sleep</span>(<span style="color:#099">0.1</span>)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">return</span>(handles)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Resolve missing DIDs</span>
</span></span><span style="display:flex;"><span>    resolved_handles <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">resolve_dids_to_handles</span>(missing_handles<span style="color:#000;font-weight:bold">$</span>subject_did)
</span></span><span style="display:flex;"><span>    resolved_map <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(subject_did <span style="color:#000;font-weight:bold">=</span> missing_handles<span style="color:#000;font-weight:bold">$</span>subject_did, handle <span style="color:#000;font-weight:bold">=</span> resolved_handles)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Update follow_records_df with resolved handles</span>
</span></span><span style="display:flex;"><span>    follow_records_df <span style="color:#000;font-weight:bold">&lt;-</span> follow_records_df <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">left_join</span>(resolved_map,
</span></span><span style="display:flex;"><span>                by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;subject_did&#34;</span>,
</span></span><span style="display:flex;"><span>                suffix <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;.resolved&#34;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">mutate</span>(handle <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">coalesce</span>(handle, handle.resolved)) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span>handle.resolved)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Find the records corresponding to users_to_unfollow</span>
</span></span><span style="display:flex;"><span>  records_to_delete <span style="color:#000;font-weight:bold">&lt;-</span> follow_records_df <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">filter</span>(handle <span style="color:#000;font-weight:bold">%in%</span> users_to_unfollow)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># If there are no matching records, exit the function</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">nrow</span>(records_to_delete) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;No matching follow records found to unfollow.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span>(<span style="color:#000;font-weight:bold">NULL</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Function to unfollow a user by deleting the follow record</span>
</span></span><span style="display:flex;"><span>  unfollow_user <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(session, repo_did, rkey) {
</span></span><span style="display:flex;"><span>    req <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">request</span>(<span style="color:#d14">&#34;https://bsky.social/xrpc/com.atproto.repo.deleteRecord&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">req_method</span>(<span style="color:#d14">&#34;POST&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">req_headers</span>(Authorization <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#34;Bearer &#34;</span>, session<span style="color:#000;font-weight:bold">$</span>accessJwt)) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">req_body_json</span>(<span style="color:#900;font-weight:bold">list</span>(
</span></span><span style="display:flex;"><span>        collection <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;app.bsky.graph.follow&#34;</span>,
</span></span><span style="display:flex;"><span>        repo <span style="color:#000;font-weight:bold">=</span> repo_did,
</span></span><span style="display:flex;"><span>        rkey <span style="color:#000;font-weight:bold">=</span> rkey
</span></span><span style="display:flex;"><span>      ))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    resp <span style="color:#000;font-weight:bold">&lt;-</span> req <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">req_error</span>(
</span></span><span style="display:flex;"><span>        is_error <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">function</span>(resp)
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>      ) <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">req_perform</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">resp_status</span>(resp) <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#099">400</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Failed to unfollow rkey &#34;</span>,
</span></span><span style="display:flex;"><span>              rkey,
</span></span><span style="display:flex;"><span>              <span style="color:#d14">&#34;: &#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#900;font-weight:bold">resp_status_desc</span>(resp))
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">print</span>(<span style="color:#900;font-weight:bold">resp_body_string</span>(resp))
</span></span><span style="display:flex;"><span>    } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Successfully unfollowed rkey &#34;</span>, rkey)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Unfollow each user</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Unfollowing users who meet the criteria...&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">for</span> (i <span style="color:#000;font-weight:bold">in</span> <span style="color:#900;font-weight:bold">seq_len</span>(<span style="color:#900;font-weight:bold">nrow</span>(records_to_delete))) {
</span></span><span style="display:flex;"><span>    rkey <span style="color:#000;font-weight:bold">&lt;-</span> records_to_delete<span style="color:#000;font-weight:bold">$</span>rkey[i]
</span></span><span style="display:flex;"><span>    handle <span style="color:#000;font-weight:bold">&lt;-</span> records_to_delete<span style="color:#000;font-weight:bold">$</span>handle[i]
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Unfollowing user: &#34;</span>, handle)
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">unfollow_user</span>(session, self_did, rkey)
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">Sys.sleep</span>(<span style="color:#099">0.1</span>) <span style="color:#998;font-style:italic"># Pause to respect rate limits</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Disconnect from the database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;Unfollowing process completed.&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Run the function</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">unfollow_users_based_on_criteria</span>(db_path)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Function to create a histogram of average sentiment scores of remaining follows</span>
</span></span><span style="display:flex;"><span>create_histogram_of_avg_sentiment <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(db_path) {
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Connect to the database</span>
</span></span><span style="display:flex;"><span>  con <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbConnect</span>(duckdb<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">duckdb</span>(), db_path)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Retrieve the list of users you are currently following</span>
</span></span><span style="display:flex;"><span>  follows_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(con, <span style="color:#d14">&#34;SELECT * FROM follow_relationships WHERE tag = &#39;wwd-following&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Retrieve the average sentiment scores</span>
</span></span><span style="display:flex;"><span>  avg_sentiment_df <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dbGetQuery</span>(
</span></span><span style="display:flex;"><span>    con,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;SELECT author_handle AS handle, average_sentiment FROM wwd_following_average_sentiment&#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Merge the data to get the average sentiment scores of your current follows</span>
</span></span><span style="display:flex;"><span>  merged_df <span style="color:#000;font-weight:bold">&lt;-</span> follows_df <span style="color:#000;font-weight:bold">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">inner_join</span>(avg_sentiment_df, by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;handle&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Disconnect from the database</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">dbDisconnect</span>(con, shutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Check if there are any data to plot</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">nrow</span>(merged_df) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">message</span>(<span style="color:#d14">&#34;No data available to plot.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span>(<span style="color:#000;font-weight:bold">NULL</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Plot the histogram</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">ggplot</span>(merged_df, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> average_sentiment)) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">geom_histogram</span>(
</span></span><span style="display:flex;"><span>      binwidth <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>,
</span></span><span style="display:flex;"><span>      fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;steelblue&#34;</span>,
</span></span><span style="display:flex;"><span>      color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;black&#34;</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;Histogram of Average Sentiment Scores of Remaining Follows&#34;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;Average Sentiment Score&#34;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;Number of Users&#34;</span>) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">theme_minimal</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Run the function to create the histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">create_histogram_of_avg_sentiment</span>(db_path)
</span></span></code></pre></div><img src="/blog/bsky_unfollow_negative_people/index_files/figure-html/unnamed-chunk-4-1.png" width="672" />

        
        <details closed class="f6 fw7 input-reset">
  <dl class="f6 lh-copy">
    <dt class="fw7">Posted on:</dt>
    <dd class="fw5 ml0">November 24, 2024</dd>
  </dl>
  <dl class="f6 lh-copy">
    <dt class="fw7">Length:</dt>
    <dd class="fw5 ml0">13 minute read, 2739 words</dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Categories:</dt>
    <dd class="fw5 ml0"> <a href="http://localhost:4321/categories/bluesky">Bluesky</a> </dd>
  </dl>
  
  
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Tags:</dt>
    <dd class="fw5 ml0"> <a href="http://localhost:4321/tags/r">R</a>  <a href="http://localhost:4321/tags/duckdb">DuckDB</a>  <a href="http://localhost:4321/tags/bluesky">Bluesky</a> </dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">See Also:</dt>
    
    <dd class="fw5 ml0"><a href="/blog/bsky_sentiment_index/">Bluesky Sentiment Indexing</a></dd>
    
    <dd class="fw5 ml0"><a href="/blog/aw_bsky_bot/">Andrew Wheiss&#39;s Bluesky Bot</a></dd>
    
    <dd class="fw5 ml0"><a href="/blog/foursquare/">Foursquare S3 Data</a></dd>
    
  </dl>
</details>

      </section>
      <footer class="post-footer">
        <div class="post-pagination dt w-100 mt4 mb2">
  
  
  
  
    <a class="next dtc pl2 tr v-top fw6"
    href="http://localhost:4321/blog/bsky_sentiment_index/">Bluesky Sentiment Indexing &rarr;</a>
  
</div>

      </footer>
    </article>
    
      <div class="post-comments pa0 pa4-l mt4">
  
    
      <script src="https://utteranc.es/client.js"
              repo="stewing-co/warp_and_weft_data"
              issue-term="pathname"
              theme="boxy-light"
              label="comments :crystal_ball:"
              crossorigin="anonymous"
              async
              type="text/javascript">
      </script>
    
  
</div>

    
  </section>
</main>
<footer class="site-footer pv4 bt b--transparent ph5" role="contentinfo">
  <nav class="db dt-l w-100">
    <p class="site-copyright f7 db dtc-l v-mid w-100 w-33-l tc tl-l pv2 pv0-l mv0 lh-copy">
      &copy; 2024 Warp and Weft Data, Atlanta, GA
      <span class="middot-divider"></span>
      Made with <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/hugo-apero/" rel="dct:source">Hugo Apéro</a></span>.
      <br />
      
Based on <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/formspree/blogophonic-hugo" rel="dct:source">Blogophonic</a></span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://formspree.io" property="cc:attributionName" rel="cc:attributionURL">Formspree</a>.
    </p>
    
    <div class="site-social-links db dtc-l v-mid w-100 w-33-l tc pv2 pv0-l mv0">
      <div class="social-icon-links" aria-hidden="true">
  
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://github.com/stewing-co" title="github" target="_blank" rel="me noopener">
      <i class="fab fa-github fa-lg fa-fw"></i>
    </a>
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://bsky.app/profile/warpandweftdata.com" title="bluesky" target="_blank" rel="me noopener">
      <i class="fab fa-bluesky fa-lg fa-fw"></i>
    </a>
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://www.linkedin.com/in/stewing-in/" title="linkedin" target="_blank" rel="me noopener">
      <i class="fab fa-linkedin fa-lg fa-fw"></i>
    </a>
  
</div>

    </div>
    
    <div class="site-links f6 db dtc-l v-mid w-100 w-67-l tc tr-l pv2 pv0-l mv0">
      
      <a class="dib pv1 ph2 link" href="/license/" title="License">License</a>
      
      <a class="dib pv1 ph2 link" href="/contact/" title="Contact form">Contact</a>
      
    </div>
  </nav>
  
    <script>

    var i, text, code, codes = document.getElementsByTagName('code');
    for (let i = 0; i < codes.length;) {
      code = codes[i];
      if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
        text = code.textContent;
        if (/^\$[^$]/.test(text) && /[^$]\$$/.test(text)) {
          text = text.replace(/^\$/, '\\(').replace(/\$$/, '\\)');
          code.textContent = text;
        }
        if (/^\\\((.|\s)+\\\)$/.test(text) ||
            /^\\\[(.|\s)+\\\]$/.test(text) ||
            /^\$(.|\s)+\$$/.test(text) ||
            /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
          code.outerHTML = code.innerHTML;  
          continue;
        }
      }
      i++;
    }
</script>

  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>



    
  
  
</footer>

      </div>
    </body>
</html>
